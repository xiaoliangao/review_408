# chap1 绪论

## 一、计算机网络概述

### 1.1 计算机网络的概念

#### 广义观点

低级阶段：只要能实现远程信息处理或能进一步达到资源共享的系统就是计算机网络

#### 资源共享观点

符合目前计算机网络的基本特征：以能够相互共享资源（目的）的方式互联起来的自治计算机（组成单元）系统的集合（必须遵循统一规则——网络协议）。

#### 用户透明性观点

网络未来发展追求的目标：存在一个能为用户自动管理资源的网络操作系统，能够调用用户所需要的资源，而整个网络对用户透明，用户无需了解网络的存在、资源的位置信息。

### 1.2 计算机网络的组成

#### 组成部分

- 硬件：主机/端系统、通信链路、交换设备和通信处理机（如网卡）
- 软件：各种实现资源共享的软件、方便用户使用的各种工具软件。多属于应用层
- 协议：计算机网络的核心。规定了网络传输数据时所遵循的规范

#### 工作方式

- 边缘部分：所有连接到因特网上、供用户直接使用的主机
- 核心部分：大量的网络和连接这些网络的路由器，为边缘部分提供连通性和交换服务

#### 功能组成

- 通信子网：由传输介质、通信设备、网络协议组成，使网络具有数据传输、交换、控制和存储的能力，实现联网计算机之间的数据通信
- 包括物理层、数据链路层和网络层
- 资源子网：实现资源共享功能的设备及其软件的集合
- OSI模型的上三层，包括传输层、会话层、表示层

### 1.3 计算机网络的功能

- 数据通信：计算机网络最基本和最重要的功能
- 资源共享：可以是软件共享、数据共享，也可以是硬件共享。使计算机网络中的资源互通有无、分工协作
- 分布式处理：可以将复杂任务分配给网络中其他计算机系统，从而利用空闲计算机资源以提高整个系统的利用率
- 提高可靠性：网络中的计算机互为替换机
- 负载均衡：将工作任务均衡地分配给网络中的各台计算机

### 1.4 计算机网络的分类

#### 按分布范围

- 广域网（WAN）：提供长距离通信，覆盖范围达几十千米到几千千米。**是因特网的核心部分**。连接广域网各结点的链路一般都是高速链路、具有较大通信容量。
- 城域网（MAN）：覆盖范围达5~50km，大多采用以太网技术
- 局域网（LAN）：覆盖范围达几十米到几千米。局域网使用广播技术，而以太网使用交换技术
- 个人区域网（PAN）：个人电子设备（平板电脑、手机等）用无线技术连接起来的网络

若中央处理器之间的距离为1m的数量级甚至更小，则一般称为多处理机系统而不是计算机网络

#### 按传输技术

- 广播式网络：所有联网计算机共享一个公共通信信道。局域网采用广播式通信技术，广域网中的无线、卫星通信网络也采用广播式通信技术
- 点对点网络：每条物理线路连接一台计算机，若两台计算机之间没有直接物理线路，则分组传输要通过中间结点进行接收、存储和转发，直至到达目的结点。
- 重要区别：是否采用分组存储转发与路由选择机制

#### 按拓扑结构分类

- 主要指通信子网的拓扑结构
- 分为总线形、星形、环形、网状网络等。前三者多用于局域网，网状网络多用于广域网
- 总线形网络：
- 用单根传输线连接多台计算机。
- 建网容易、增/减结点方便、节省线路
- 重负载时通信效率不高、总线任意一处**对故障敏感**
- 星形网络：
- 每个终端或计算机都以单独的线路与中央设备相连。中央设备早期是计算机，现在一般是交换机或路由器。
- 便于集中控制和管理
- 成本高、中央设备对故障敏感
- 环形网络：
- 所有计算机连接成一个环。典型例子是令牌环局域网
- 可以是单环也可以是双环。
- 环中信号单向传输
- 网状网络：
- 每个结点至少有两条路径与其他结点相连，多用于广域网。有规则型和非规则型两种
- 可靠性高
- 控制复杂、线路成本高

#### 按使用者分类

- 公用网：电信公司出资建造的大型网络
- 专用网：某个部门为满足本单位特殊业务的需要而建造的网络，不向本单位以外的人提供服务

#### 按交换技术分类

- 电路交换网络：
- 源结点和目的结点之间建立一条专用的通路用于传送数据，包括建立连接、传输数据、断开连接三个阶段。
- 典型代表：传统电话网络
- 特点：整个报文的比特流连续地从源点直达终点
- 优点：数据直接传送、时延小
- 缺点：线路利用率低、不能充分利用线路容量、不便进行差错控制
- 报文交换网络：
- 用户数据加上源地址、目的地址、校验码等辅助信息，封装成报文。整个报文传送到相邻结点，全部存储后，再转发给下一个结点。每个报文可以独立选择到达目的结点的路径
- 特点：存储转发
- 优点：较为充分地利用线路容量、可以实现不同链路之间不同数据传输速率的转换、格式转换、一对多/多对一访问、差错控制
- 缺点：增大资源开销、增加缓冲时延、需要额外的控制机制来保证多个报文的顺序不乱序、缓冲区难以管理（报文长度不确定）
- 分组交换网络：
- 将数据分成较短的固定长度的数据块，加上目的地址、源地址等辅助信息封装成分组。
- 特点：存储转发
- 优点：缓冲区易于管理、平均时延更小、网络占用的平均缓冲区更少、更易于标准化和应用

#### 按传输介质

- 有线：双绞线网络、同轴电缆网络等
- 无线：蓝牙、微波、无线电

## 二、网络性能衡量指标

#### 数据量

- 单位：B（Byte，1 B = 8 bit）
- 进制：2进制，1 K = $2^{10}$，1 M = $2^{20}$，1 G = $2^{30}$

#### 速率

- 单位：bit/s
- 进制：10进制，1 K = $10^3$，1 M = $10^6$， 1G = $10^9$

#### 带宽

- 单位：bit/s
- 含义：单位时间内某信道所能通过的最高数据率

#### 吞吐量

- 单位：同数据量
- 含义：单位时间内通过某个网络/信道/接口的实际数据量

#### 时延

- 单位：s 或 ms
- 构成：
- **发送时延/传输时延**：数据从节点到全部传输到信道上的时间 $$ 发送时延 = \frac{数据帧长度(bit)}{发送速率(bit/s)} $$ 传播时延：电磁波在信道中传播一定距离所花费的时间（注意，与数据量无关）。 $$ 传播时延 = \frac{信道长度(m)}{电磁波在信道上的传播速率(m/s)} $$ 常用速率：光纤（$2.0\times 10^8m/s$），铜线（$2.3\times10^8m/s$）
- 处理时延：主机或路由器分析首部、提取数据、差错检验、查找转发表等所耗费的时间
- 排队时延：需要处理的分组可能会在路由器中堆积等待处理。若分组过多，导致队列溢出，分组丢失，此时排队时延为无穷大。
- 数据总时延 $$ 总时延 = 发送时延+传播时延+处理时延+排队时延 $$
- 注意点：
- 高速链路/高带宽链路：本质上只是减小了发送时延，与数据传送时间无关，不能说使比特传送更快。
- 光纤比铜线速率更高：这是光纤信道允许节点用更高的速率将数据发送到信道上，而不是传送速率更快。

#### 时延带宽积

- 单位：同数据量
- 含义：一段链路中最多可充满的数据量。将链路视为一段空心管道，则传播时延为它的长度，带宽为它的底面积。

$$ 时延带宽积 = 传播时延\times 带宽 $$

#### 往返时间 RTT

- 单位：s 或 ms
- 含义：通信双方完成一次双向交互所需的时间，即主机A发出的数据到达信道（开始计时）→主机B发回响应→主机A收到响应（结束计时）

#### 利用率

- 信道利用率：某一信道有数据通过的时间占比
- 网络利用率：全网络信道利用率的加权平均值
- **信道利用率或网络利用率过高会产生非常大的时延**（因为网络中大部分时间都有数据，意味着路由器和主机需要一直处理转发分组，这部分速率跟不上会造成分组堆积在各节点中等待处理，导致时延越来越大） $$ D（网络当前时延） = \frac {D_0（网络空闲时延）}{1-U（网络当前利用率）} $$

## 三、网络体系结构及参考模型

### 3.1 OSI参考模型

- 共7层：物理层、数据链路层、网络层、传输层、会话层、表示层、应用层
- 低三层为通信子网、高三层为资源子网；传输层承上启下

#### 物理层

1. 传输单位：比特
2. 任务：在节点之间透明地传输比特流
3. 功能：在物理媒体上为数据端设备透明地传输原始比特流
4. 负责解决的问题：确定传输媒体接口的特性
5. 机械特性：接口所用接线器的形状和尺寸、引线数目和排列、固定和锁定装置等。
6. 电气特性：在接口电缆的各条线上出现的电压的范围。
7. 功能特性：某条线上出现的某一电平的电压的意义。
8. 过程特性：对于不同功能的各种可能事件的出现顺序。

#### 数据链路层

1. 传输单位：帧
2. 对象：两个相邻节点之间
3. 任务：将网络层传来的IP数据报组装成帧，并在两个相邻节点之间的链路上传送数据
4. 负责解决的问题：
5. **成帧**：将网络层交下来的IP数据报组装成帧
6. 物理寻址：收发双方的物理地址（同一个网络/本地网络）
7. 访问控制：广播信道，如何决定哪台设备可以发送和接收数据
8. **差错控制**：需要检查所收到的帧是否有差错，并采取响应措施（直接丢弃或通知重传）
9. **流量控制**：接收方采取措施，使发送方不要过快发送

#### 网络层

1. 传输单位：数据报
2. 对象：两个主机之间（可能跨越多个网络）
3. 任务：负责为分组交换网上的不同主机提供通信
4. 负责解决的问题：
5. 分组：将运输层的报文段或用户数据报封装成分组或包。
6. 逻辑寻址：跨网络通信，需要给主机重新编制逻辑地址。物理寻址是基于同一个网络或本地网络。
7. 路由选择：寻找路径能够将分组通过连接设备（路由器）到目的主机。在TCP/IP体系中，网络层(网际层)使用IP协议，IP层分组叫做IP数据报，简称数据报。
8. **流量控制、拥塞控制、差错控制**、网际互连

#### 传输层

1. 传输单位：报文段（TCP）或用户数据报（UDP）
2. 对象：两个进程之间
3. 任务：为两个主机中进程之间的通信提供**通用**的数据传输服务
4. 功能：复用和分用。复用是指多个应用层进程可同时使用下面传输层的服务；分用是指传输层把收到的信息分别交付给上面应用层中相应的进程
5. 负责解决的问题：
6. 服务点寻址：通过端口地址标识特定进程，从而将报文交付对应进程
7. 分片与重组：报文可能过长，需要分片交付给下一层；收到的报文是分片的，需要重组成完整报文
8. **连接控制、流量控制、差错控制、服务质量、数据传输管理**

#### 会话层

- 允许不同主机上各个进程进行会话/建立同步（SYN）
- 任务：管理主机间的会话进程，包括建立、管理及终止。
- 功能：使用校验点使得通信失效时能从校验点处恢复通信，实现数据同步

#### 表示层

- 任务：处理在两个通信系统中交换信息的表示方式。采用抽象的标准方法定义数据结构，并采用标准编码形式。
- 功能：数据压缩、加密和解密等

#### 应用层

（1）对象：两个进程之间

（2）任务：负责给用户提供服务（注意运输层只是传输数据，应用层则是规定如何收发、利用数据）。通过应用进程间的交互完成特定网络应用。

（3）负责解决的问题：

- 定义应用进程之间的通信与交互规则

#### 总结

- 数据链路层、网络层、传输层都有差错控制和流量控制功能

### 3.2 TCP/IP模型

![image-20221103130017591](https://streamazure.github.io/Computer_Basics_Notes/Computer_Network_Notes/0x01%20%E7%BB%AA%E8%AE%BA/image-20221103130017591.png)

![image-20221210234050521](https://streamazure.github.io/Computer_Basics_Notes/Computer_Network_Notes/0x01%20%E7%BB%AA%E8%AE%BA/image-20221210234050521.png)

![image-20221103130147517](https://streamazure.github.io/Computer_Basics_Notes/Computer_Network_Notes/0x01%20%E7%BB%AA%E8%AE%BA/image-20221103130147517.png)

### 3.2 分组、协议、服务

#### 分组

（1）发送方将较长的报文划分为若干个等长的数据段，在数据段前面加上必要的控制信息（报文）构成**分组**，进行传输。由接收方重组。

（2）存储转发，每个分组独立地选择最合适的转发路由，体现**灵活性**。

（3）存储转发，分组传输过程中动态分配传输带宽，断续地逐段占用通信资源，体现**高效性**。

（4）以分组作为传输单位，主机之间不需要预先建立连接即可发送分组，体现**迅速**性。

（5）采用可靠的网络协议，分布式多路由的分组交换网，使网络有很好的生存性（不至于因为网络拥塞或少数节点、链路损坏而导致整体瘫痪），体现**可靠性**。

#### 协议

规定数据交换格式及相关同步问题。

协议三要素：

（1）语法：数据与控制信息的结构与格式（怎么说）

（2）语义：发出何种控制信息，完成何种动作，作出何种响应（说什么）

（3）同步：事件实现顺序的详细说明（何时说）

形式：

（1）人来阅读与理解的文字描述

（2）计算机能理解的程序代码

#### 服务

在计算机网络体系结构中，下层为相邻的上层提供的功能调用。

服务原语：上层使用下层提供的服务时与下层交换的命令

- 请求：服务用户→服务提供者，请求完成某项工作
- 指示：服务提供者→服务用户，指示用户做某件事情
- 响应：服务用户→服务提供者，作为对指示的响应
- 证实：服务提供者→服务用户，作为对请求的证实

有应答服务包含全部4类原语，无应答服务只有请求和指示两类原语

**并非在一层内完成的全部功能都称为服务，只有那些能被高一层实体看见的功能才称为服务**

服务的分类：

- 面向连接服务与无连接服务
- 可靠服务和不可靠服务
- 可靠服务：网络具有纠错、检错、应答机制，能保证数据正确、可靠地传送到目的地
- 不可靠服务：网络只是尽量正确、可靠地传送，不能保证一定正确、可靠
- 有应答服务和无应答服务

#### 协议与服务的区别与联系

（1）协议是“水平”的，是控制对等实体之间通信的规则；服务是“垂直”的，是下层向上层通过层间接口（**服务访问点，Service Access Point，SAP**，是*抽象的逻辑接口*）提供的

（2）层与层之间交换的数据单位为服务数据单元（Service Data Unit，SDU），对等层次之间传送的数据单位为协议数据单元（Protocol Data Unit，PDU）

（3）本层协议的实现保证了能够向上一层提供服务，而实现本层协议又需要使用下一层所提供的服务。本层只能看见所提供的服务，而看不见下一层所使用的协议；服务也仅限于本层所看到的部分，不一定是下一层所完成的全部功能。

### 3.3 TCP/IP模型与OSI参考模型的比较

#### 相同点

1. 都采取分层的体系结构
2. 都基于独立的协议栈的概念
3. 都可以解决异构网络的互联，实现世界上不同厂家生产的计算机之间的通信

#### 不同点

1. OSI精确地定义了三个主要概念：服务、协议和接口；而TCP/IP模型没有明显区分
2. OSI通用性良好；TCP/IP模型不适合任何其他非TCP/IP的协议栈，协议能够匹配模型
3. TCP/IP模型在设计之初就考虑到了多种异构网的互联问题，并将IP作为一个单独的重要层次；而OSI认识到IP重要性后才在网络层中划分出一个子层
4. **OSI在网络层支持无连接和面向连接的通信，而在传输层仅有面向连接的通信；TCP/IP在网络层仅有无连接的通信，而在传输层支持无连接和面向连接的通信**

# chap2 物理层

## 一、通信基础

### 1.1 基本概念

#### 数据、信号、码元

通信的目的是传送信息，信息的实体是数据，数据在传输过程中的存在形式是信号。

信号可分为模拟信号和数据信号

- 模拟信号：连续变化的
- 数字信号：取值仅允许为有限的几个离散数值的

数据传输方式可分为串行传输和并行传输

- 串行传输：1比特1比特地按照时间顺序传输
- 并行传输：若干比特通过多条通信信道同时传输

码元是数字信号的计量单位，代表不同离散数值的基本波形，它用一个固定时长的数字脉冲表示一位k进制数字，这个时长内的信号称为k进制码元，而该时长称为码元宽度

**1码元可以携带若干比特的信息**

#### 信源、信道、信宿

一个数据通信系统主要划分为信源、信道、信宿三部分

- 信源：产生和发送数据的源头
- 信宿：接收数据的终点，通常是计算机或其他数字终端装置
- 信道：不等同于电路，是信号的传输媒介，一般用来表示向某个方向传送信息的介值，因此一条通信线路往往包含一条发送信道和一条接收信道
- 模拟信道：传输模拟信号
- 数字信道：传输数字信号
- 无线信道、有线信道

信道上传输的信号分为基带信号和宽带信号

- 基带信号：将数字信号1和0用两种不同电压表示，然后送到数字信道上传输（基带传输），不经过调制。基带传输一般用于计算机内部和局域网。
- 频带传输：将基带信号进行调制后送到模拟信道上传输。在进行远距离传输或无线传输时，数字信号必须用频带传输进行传输
- 宽带信号：基于频带传输，但将基带信号进行调制后形成频分复用模拟信号，然后送到模拟信道上传输（宽带传输）

通信双方信息的交互方式可分为单向通信、半双工通信、全双工通信

- 单向通信：只有一个方向的通信，仅需要一条信道。如无线电广播、电视广播
- 半双工通信：双向通信，但同一时刻只能有一个方向传输信息。需要两条信道
- 全双工通信：通信双方可以同时发送和接收信息。需要两条信道

信道的极限容量：信道的最高码元传输速率/信道的极限信息传输速率

#### 速率、带宽

- 速率：也称为数据率，表示单位时间内传输的数据量
- 码元传输速率/波特率：表示单位时间内数字通信系统所传输的码元个数/脉冲个数/信号变化的次数，单位是波特（Baud）
- 信息传输速率/比特率：表示单位时间内数字通信系统传输的二进制码元个数（即比特数），单位是bit/s
- 比特率=波特率×$log_2{n}$
- 带宽：单位时间内从网络中某一点到另一点所能通过的“最高数据率”

### 1.2 奈奎斯特定理与香农定理

#### 奈奎斯特定理

码间串扰：高频分量在通过信道时受到衰减，导致接收端收到的信号波形失去码元之间的清晰界限

奈奎斯特定理：

- 给出了不受到码间串扰时码元传输速率的上限值
- 理想低通信道下极限数据传输速率=$2W\log_2{V}$，其中W为理想低通信道的带宽，V为每个码元离散电平的数量
- 任何信道中，码元传输速率有上限。超过此上限会出现严重的码间串扰问题
- 信道的频带更宽（即通过的信号高频分量越多），就能用更高的速率进行传输
- 只给出了码元传输速率的限制，未限制信息传输速率

#### 香农定理

- 信道的极限数据传输速率=$W\log_2{(1+S/N)}$，其中W为信道的带宽，S为信道所传输信号的平均功率，N为信道内部的高斯噪声功率。S/N为信噪比。
- 信噪比越大，极限数据传输速率越高
- 若传输带宽和信噪比确定，则其传输速率上限也确定
- 只要信息传输速率低于此极限值，就一定能找到某种方法来实现无差错的传输
- 实际信道能达到的传输速率要比这个极限值低不少

### 1.3 计算相关

- 比特率=波特率×$log_2{n}$，n为一个码元的有效离散值个数。
- 若有效离散值个数为2^k个，则一个码元包含k个比特
- **无噪声**信号满足奈奎斯特定理，最大传输速率为$2W\log_2{V}$，W为信道带宽。V为一个码元的有效离散值个数。“每个信号包含8级”的意思是一个码元有8个离散值
- 若题目给出信噪比，需要综合考虑香农定理和奈奎斯特定理，取两者结果的较小值。![image-20221104221447749](https://streamazure.github.io/Computer_Basics_Notes/Computer_Network_Notes/0x02%20%E7%89%A9%E7%90%86%E5%B1%82/image-20221104221447749.png)

根据香农定理，最大数据传输速率=4k×log_2(127+1)=28k；根据奈奎斯特定理，**“二进制信号”表明一个码元有2个离散值**，即V=2，最大传输速率=2×4k×log_2(2)=8k；综上，最大数据传输速率为8k，选B。

- 信噪比的db/分贝单位换算：10lg{S/N}dB。如，当信噪比为30db时，实际上S/N=10^(30/10)=10^3=1000
- 若只给采样频率不给带宽，则将采样频率视为带宽。如一个信道每1/8s采样一次，带宽为8Hz.
- **若题目指明使用曼彻斯特编码，则1个比特用2个码元表示，波特率是数据率的2倍**

### 1.4 编码与调制

编码：将数据变换为数字信号

调制：将数据变换为模拟信号

#### 数字数据编码为数字信号

用于基带传输，即在基本不改变数字数据信号频率的情况下，直接传输数字信号。

编码规则：规定用什么样的数字信号表示1，什么样的数字信号表示0。

![image-20221104173349175](https://streamazure.github.io/Computer_Basics_Notes/Computer_Network_Notes/0x02%20%E7%89%A9%E7%90%86%E5%B1%82/image-20221104173349175.png)

常用的编码规则：

- 归零编码/RZ
- 高电平表示1，低电平表示0（或相反）
- 在每个时钟周期的中间跳变到低电平。
- 自同步机制：接收方可以通过归零调整时钟基准
- 归零占用一部分带宽，对传输效率有一定影响
- 非归零编码/NRZ
- 高电平表示1，低电平表示0（或相反），每个时钟周期中间不归零。
- 无法传递时钟信号，双方难以同步。如果想同步，需要都带有时钟线
- 反向非归零编码/NRZI
- 用信号的翻转代表0（发生跳变后的那个时钟周期是0），信号保持不变代表1
- 翻转的信号本身可以作为通知机制，因此集成了RZ和NRZ的优点，既能传输时钟信号又能尽量不损失系统带宽
- USB2.0通信采用NRZI编码
- 曼彻斯特编码
- 将一个码元分为两个相等的间隔，若前高后低则代表码元1，若前低后高则代表码元0（或相反）
- 每个码元的中间出现电平跳变，既作为时钟信号，又作为数据信号。
- 所占频带宽度是原始基带宽度的两倍
- 以太网通信使用曼彻斯特编码
- 差分曼彻斯特编码
- 若当前码元为1，则当前码元的前半个码元的电平与上一个码元的后半个码元的电平相同；若码元为0，则相反。
- 每个码元的中间出现电平跳变，可以实现自同步，抗干扰性较好
- 局域网传输常用差分曼彻斯特编码
- 4B/5B编码
- 每4位数据作为一组，然后按照编码规则转换为相应的5位码。5位码中只采用其中16种对应16种不同的4位码，其他16种作为控制码或保留

#### 数字数据调制为模拟信号

![image-20221104181756126](https://streamazure.github.io/Computer_Basics_Notes/Computer_Network_Notes/0x02%20%E7%89%A9%E7%90%86%E5%B1%82/image-20221104181756126.png)

#### 模拟数据编码为数字信号

- **采样定理/奈奎斯特定理：要保证采样后的数字信号完整保留原始模拟信号的信息，采样频率必须≥2倍的原始信号最大频率**
- 编码步骤：
- 采样：对模拟信号进行周期性扫描，把时间上连续的信号变成时间上离散的信号
- 量化：将采样取得的电平幅值按一定的分级标度转化为对应的数字值并取整数
- 编码：把量化的结果转换为与之对应的二进制编码
- 典型例子：对音频信号进行编码的脉码调制

#### 模拟数据调制为模拟信号

- 可能需要较高的频率来保证传输有效性
- 可以使用频分复用技术
- 电话机和本地局交换机采用

### 1.5 电路交换、报文交换、分组交换

#### 电路交换

双方预先建立一条专用的物理通信路径（由通信双方之间的交换设备和链路逐段连接而成），并在数据传输期间一直被独占

数据传输期间，电路上的任何结点（除源节点和目的结点）都采用直通方式接收和发送数据，不存在存储转发

分为三个阶段：连接建立、数据传输、连接释放

优点：

- 通信时延小：数据都是直达的
- 有序传输
- 没有冲突
- 适用范围广：既适用于传输模拟信号，又适用于传输数字信号
- 实时性强
- 控制简单

缺点：

- 建立连接时间长
- 不具有差错控制能力
- 线路独占，使用效率低
- 灵活性差。只要出了任何一点故障，就必须重新拨号建立新的连接，不利于紧急和重要的通信
- 难以规格化。不同类型、不同规格、不同速率的终端很难相互进行通信，也很难进行差错控制

#### 报文交换

以报文为单位进行数据交换，报文携带目的地址、源地址等信息。

在交换结点采用存储转发

优点：

- 无须建立连接
- 动态分配线路
- 提高线路可靠性
- 提高线路利用率
- 提供多目标服务

缺点：

- 要进行存储转发，引起转发时延
- 对报文大小没有限制，要求网络结点有较大的缓存空间

#### 分组交换

以分组为单位进行数据交换，要发送的数据划分为等大的数据块，加上必要的控制信息后构成分组。

在交换结点采用存储转发

优点：

- 无建立时延
- 线路利用率高
- 简化了存储管理：分组长度固定，相应的缓冲区大小也固定
- 加速传输：分组是逐个传输的，分组存储和分组转发可以并行，构成流水线，从而减少报文传输时间。此外一个分组占用缓冲区比一个报文占用缓冲区小得多，从而减少了因缓冲区不足而等待的时间
- 减少了出错概率和重发数据量

缺点：

- 存在传输时延
- 需要传输额外的信息，一定程度上降低了通信效率，增加了处理时间，使控制复杂，时延增加
- 当采用数据报服务时，可能会出现失序、丢失或重复问题；采用虚电路服务也只能避免失序问题

![image-20221104201008093](https://streamazure.github.io/Computer_Basics_Notes/Computer_Network_Notes/0x02%20%E7%89%A9%E7%90%86%E5%B1%82/image-20221104201008093.png)

### 1.6 数据报和虚电路

#### 数据报

- 不需要建立连接
- 尽最大努力交付，不保证可靠性，分组到达可能不是有序的
- **分组要包含发送端和接收端的完整地址**
- 分组在交换结点存储转发时，需要排队等候处理
- 网络具有冗余路径
- 存储转发延时小，提高网络吞吐量
- 收发双方不独占某条链路，资源利用率高

#### 虚电路

- 在虚电路上的每个结点都维护一张虚电路表，记录所有已打开的虚电路的信息
- 虚电路号
- 前一结点和下一结点的标识
- 虚电路的建立和拆除需要时间开销，不适用于交互式应用和小量短分组，但对于长时间、频发的数据交换而言效率较高
- 虚电路在连接建立时确定路由选择，从而确定传输路径
- 提供可靠通信功能，保证每个分组正确且有序到达，且可以进行流量控制
- 由于传输路径是事先确定的，一旦路径中的某个结点或某个链路失效，所有经过该结点或该链路的虚电路都将被破坏
- **分组首部不包含目的地址，而是虚电路标识符，相对于数据报方式开销小。**

![image-20221104201822911](https://streamazure.github.io/Computer_Basics_Notes/Computer_Network_Notes/0x02%20%E7%89%A9%E7%90%86%E5%B1%82/image-20221104201822911.png)

## 二、传输介质

### 2.1 导向与非导向传输介质

- 导向传输介质：电磁波被导向沿着固体媒介（铜线或光纤）传播
- 非导向传输介质：空气、真空或海水等

#### 双绞线

- 由两根采用一定规则并排绞合的、相互绝缘的铜导线组成。
- 抗电磁干扰：绞合减少对相邻导线的电磁干扰。在双绞线的外层再加一层用金属丝编织成的屏蔽层，构成屏蔽双绞线。没有屏蔽层的双绞线为非屏蔽双绞线
- 价格便宜，是最常用的传输介质之一
- 在局域网和传统电话网中普遍使用
- 带宽取决于铜线粗细和传输距离
- 支持模拟传输和数字传输，通信距离达几千米到数十千米
- 模拟传输可用放大器放大信号；数字传输可用中继器整形失真的信号

![image-20221104210331393](https://streamazure.github.io/Computer_Basics_Notes/Computer_Network_Notes/0x02%20%E7%89%A9%E7%90%86%E5%B1%82/image-20221104210331393.png)

#### 同轴电缆

- 内导体、绝缘层、外导体屏蔽层、绝缘保护套层
- 按特性阻抗数值分为两类：50Ω同轴电缆和75Ω同轴电缆
- 50Ω同轴电缆/基带同轴电缆：传送基带数字信号；**广泛应用于局域网**
- 75Ω同轴电缆/宽带同轴电缆：传送宽带信号；**主要用于有线电视系统**
- 良好的抗干扰特性，广泛用于传输较高速率的数据，传输距离更远，价格较双绞线贵
- 其高带宽得益于它的高屏蔽性

![image-20221104210338333](https://streamazure.github.io/Computer_Basics_Notes/Computer_Network_Notes/0x02%20%E7%89%A9%E7%90%86%E5%B1%82/image-20221104210338333.png)

#### 光纤

- 纤芯、包层
- 利用光导纤维传递光脉冲进行通信。有光脉冲为1，无光脉冲为0。带宽范围极大

![image-20221104210632961](https://streamazure.github.io/Computer_Basics_Notes/Computer_Network_Notes/0x02%20%E7%89%A9%E7%90%86%E5%B1%82/image-20221104210632961.png)

- 多模光纤与单模光纤
- 多模光纤：利用光的全反射特性，将不同角度入射的多条光纤在一根光纤中传输。光源为发光二极管。长距离传输容易失真，只适合近距离传输
- 单模光纤：光线的直径减小到只有一个光的波长时，光线可以一直向前传播。制造成本高。光源为半导体激光器。可进行数公里甚至数十千米的传输而不必采用中继器，适合远距离传输
- 特点：
- 通信容量非常大
- 传输损耗小、中继距离长、对远距离传输特别经济
- 抗雷电和电磁干扰性能好
- 无串音干扰，保密性好，也不易被窃听或截取数据
- 体积小、重量轻

#### 无线传输介质

- 无线电波
- 有较强穿透能力，可以传输很长距离
- 应用于无线手机通信、WLAN等
- 向所有方向散播（注意与微波、红外线和激光对比），无须接收设备对准某个方向。大大简化通信连接。
- 微波、红外线、激光
- 都是高带宽无限通信。都需要通信双方之间存在一条视线通路，有很强方向性，都沿直线传播
- 红外通信：将信号转换为红外信号，直接在空间中传播
- 激光通信：将信号转换为激光信号，直接在空间中传播
- 微波通信：
  - 频率高、频段宽、容量大。由于沿直线传播，在地面的传播距离有限，超过一定距离后需要用到中继站。
  - 卫星通信可以克服地面微波通信距离的限制，基本能实现全球通信。优点是容量大、距离远、覆盖广；缺点是成本高、误码率较高、受气候影响大、保密性差、端到端传播时延长

### 2.2 物理层接口的特性

- 机械特性：接口所用接线器的形状和尺寸、引线数目和排列、固定和锁定装置等。
- 电气特性：在接口电缆的各条线上出现的电压的范围。
- 功能特性：某条线上出现的某一电平的电压的意义。
- 过程特性：对于不同功能的各种可能事件的出现顺序。
- 常用接口标准：EIA RS-232-C、ADSL、SONET/SDH

## 三、物理层设备

#### 中继器

- 将信号整形放大并转发，扩大网络传输的距离。原理是信号再生。
- 是用来扩大网络规模的最简单廉价的互联设备。
- 有两个端口，一个输入另一个输出。端口连接的网络是网段。
- 要求连接的两个网段必须使用同一个协议，不能连接两个具有不同速率的局域网
- 不可能通过无限使用中继器来无限延长网络，因为网络标准规定了信号的延迟范围。
- 5-4-3规则：互相串联的中继器个数不能超过4个，且4个中继器串联的5段通信介质中只有3段可以挂接计算机。

#### 集线器/Hub

- 即多端口中继器，也有整形放大功能
- 目的是扩大网络的传输范围，不具备信号的定向传送能力
- 主要使用双绞线组建共享网络，是最经济方案
- 由集线器组成的网络是共享式网络，但逻辑上仍是一个总线网
- 每个端口连接的网络是同一个网络的不同网段
- **只能在半双工状态下工作**

# chap3 数据链路层

## 一、数据链路层的功能

### 1.1 基本概念

#### 协议数据单元——帧

为网络层交付下来的网络层协议数据单元（在互联网中就是 IP 数据报）**添加首部和尾部**，就构成了**帧**。

#### 数据链路 链路

- 链路：一段点到点的物理线路，中间没有任何其他节点。主机与主机之间通信的路径通常由许多条这样链路构成。
- 数据链路：具备实现通信协议的硬件和软件（如网络适配器）的链路。

### 1.2 功能1：为网络层提供服务

- 无确认的无连接服务
- 发送时不需要建立链路连接
- 接收时不需要发回确认
- 丢失帧不负责重发
- 适用：实时通信或误码率较低的信道，如以太网
- 有确认的无连接服务
- 发送时不需要建立链路连接
- 接收时必须发回确认
- 规定时间内未收到确认信号，自动重传，提高传输可靠性
- 适用：误码率较高的信道，如无线通信
- 有确认的面向连接服务
- 建立数据链路、传输帧、释放数据链路
- 收到的每一帧都要发回确认，发送方收到确认才发下一帧，可靠性最高
- 适用：通信要求较高的场合

### 1.3 功能2：链路管理

数据链路层连接的建立、维持、释放的过程，主要用于面向连接的服务。

确认就绪状态、交换必要信息、初始化帧序号、在物理信道共享的情况下对物理信道的分配与管理

### 1.4 功能3：流量控制

限制发送方的数据流量，使其发送速率不超过接收方的接受能力。

（注：OSI中数据链路层有流量控制功能，而TCPI/IP中传输层才有）

### 1.5 功能4：组帧

将来自网络层的分组数据封装成帧，即加上首部和尾部的控制信息。

作用：

- 帧定界：首部和尾部可标识一个帧的起始和结束
- 控制信息

当数据为可打印的 ACSII 码构成的文本文件时，帧定界使用特殊的帧定界符：SOH 和 EOT。

### 1.6 功能5：透明传输

当数据为非 ACSII 码构成的文本文件时（如程序和图像），数据中可能包含与帧定界符相同的二进制代码，导致数据链路层错误识别。而数据链路层应实现**透明传输**，即需要保证无论什么样的数据都可以传输，所以对于上述情况，数据链路层必须采取措施使得数据同样可以传输（而不是直接拒绝这种数据）。

### 1.7 功能6：差错控制

传输中的错误分为位错和帧错。

**位错：帧中某些位出现差错**

- 检错编码
- 奇偶校验码
- 循环冗余码CRC
- 纠错编码
- 海明码

**帧错：帧丢失、重复、失序**

- 解决：引入定时器和编号机制

## 二、组帧

组帧主要解决帧定界、帧同步、透明传输等问题

帧是网络中信息传输的最小单位，因此组帧时既要加首部又要加尾部，以便确定该帧从哪里开始到哪里结束。

#### **字符计数法**

在帧头部适用一个计数字段来表明帧内字节数，从而可以确定帧结束的位置

若计数字段出错，即失去了帧定界，收发双方失去同步

#### **字符填充的首尾定界符法**

适用特定字符来界定一帧的开始或结束：SOH（开始） 和 EOT（结束）。

发送端在数据中的 SOH / EOT 字符前面插入一个转义字符“ESC”（注意是ASCⅡ里的ESC，不是“E”“S”“C”三个字符），使得数据不会被错误解释。

接收端删除这些转义字符后再将数据上交给网络层。

如果数据中也有 ESC 字符，则同样在前面再插入一个 ESC 字符。

#### **零比特填充的首尾标志法**（常用）

以01111110来标志一帧的开始或结束

为了避免误判，发送方在信息位上每遇到五个连续的1就自动在后面插入一个0；而接收方做逆操作，以恢复原信息

很容易由硬件来实现，性能优于字符填充法

#### **违规编码法**（常用）

即用编码方式中不允许的电平组合来界定帧的起始和终止。

如曼彻斯特编码中，数据比特“1”编码为“高-低”电平对，数据比特“0”编码为“低-高”电平对，而不会出现“高-高”电平对和“低-低”电平对。因此可以用“高-高”电平对和“低-低”电平对来作为帧界定编码序列。

只适用于采用冗余编码的特殊编码环境

## 三、差错控制

#### **奇偶校验码**

由n-1位信息元和1位校验元组成。

若采用奇校验码，则添加校验元后的n位比特中应有奇数个1

若采用偶校验码，则添加校验元后的n位比特中应有偶数个1

奇偶校验码只能检测奇数位的出错情况，不能发现偶数位的出错情况，也不知道具体是哪个位出错

#### **循环冗余码CRC**

将数据划分成组，每组 k 个比特，用 M 表示其中一组

1. 双方事先约定一个 n+1 位的除数 P （生成多项式），在 M 后面添加 n 个 0，扩充至 k+n 位
2. 计算 M 对 P 取模（过程如下图所示），所得余数 R （**帧检测序列（FCS）**） 一定为 n 位，将 R 与 M 做二进制加法，最终得到 k+n 位的 M'，发送。

![image-20221106095907028](https://streamazure.github.io/Computer_Basics_Notes/Computer_Network_Notes/0x03%20%E6%95%B0%E6%8D%AE%E9%93%BE%E8%B7%AF%E5%B1%82/image-20221106095907028.png)

1. 接收方以帧为单位进行 CRC 检验，将收到的每个帧除以 P 。若帧无差错，则所得余数必为 0，若不为 0 则表示帧存在差错。注意，当帧存在差错时，所得余数也有可能为 0 ，但只要 P 经过认真挑选，这种概率是非常非常小的。

#### **海明码**

- 什么是海明码

给定一个二进制串，按海明码编码规则，向若干个特定位置插入校验位后所构成的新的二进制串即海明码。既包含了数据本身，又包含了校验位。

海明码可以检测原二进制数据串中存在的最多2个出错位，并纠正1个出错位（如果出现3个位错则失效）

- 海明码检错、纠错的基本思想

将海明码按某种规律分为若干组，每组中的位由1个校验码负责偶校验（默认偶校验）（各校验码所负责的位可以部分重叠，并且包含自己所在的位），从而产生多组检测信息，相互之间交叉排查（计算机中是直接进行异或运算）可确定出错的具体位，从而进行纠错

- 如何构造海明码

以有效信息串`1100`为例。

1. 根据公式确定该串对应的海明码的长度$h$

   $h=n+k≤2^k-1$，其中n为有效信息串的位数，k为校验位的位数。已知n=4，则k=3时满足上式（取能满足的最小的k），因此确定校验位个数为3个，海明码长度h=7

2. 确定各校验位需要插入的具体位置

   记最低位为H1，则7位海明码共有H7、H6、H5、H4、H3、H2、H1这7个位置。

   校验位必须位于$H2^k$的位置上，即3个校验位分布在H1、H2、H4这三个位置。

   将有效信息串`1100`按原顺序放入，如下表所示

   | H7   | H6   | H5   | H4     | H3   | H2     | H1     |
   | :--- | :--- | :--- | :----- | :--- | :----- | :----- |
   | 1    | 1    | 0    | 校验位 | 0    | 校验位 | 校验位 |

3. 确定各校验位负责校验哪些位置

   简单地说，由校验位所在的位置可直接确定负责校验哪些位置。

   对于上述3个校验码，写出其位置所对应的k位二进制数，并将二进制数中的0用通配符"*"替换。

   | 位置            | H1   | H2   | H4   |
   | :-------------- | :--- | :--- | :--- |
   | 对应k位二进制数 | 001  | 010  | 100  |
   | 对应通配符      | **1  | *1*  | 1**  |

   其中：

   **1 可匹配 001、011、101、111，即H1、H3、H5、H7

   *1* 可匹配 010、011、110、111，即H2、H3、H6、H7

   1** 可匹配 100、101、110、111，即H4、H5、H6、H7

   由此确定：

   H1校验位负责校验H1、H3、H5、H7

   H2校验位负责校验H2、H3、H6、H7

   H4校验位负责校验H4、H5、H6、H7

4. 根据偶校验确定各校验位的具体值

   偶校验：确定校验位的值，使它所负责的位（由上文可知这包括它自己）中包含偶数个1

   由上述规则可以确定最终的7位海明码：

   | H7   | H6   | H5   | H4   | H3   | H2   | H1   |
   | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
   | 1    | 1    | 0    | 0    | 0    | 0    | 1    |

5. 海明码如何检错

检查海明码中各组是否都具有偶数个1

由上文，H1、H3、H5、H7为1组，H2、H3、H6、H7为1组，H4、H5、H6、H7为1组

以H5出错为例，出错意味着由原文的0变为1，如下表所示：

|              | H7   | H6   | H5   | H4   | H3   | H2   | H1   |
| :----------- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| 原文信息     | 1    | 1    | 0    | 0    | 0    | 0    | 1    |
| 接收到的信息 | 1    | 1    | 1    | 0    | 0    | 0    | 1    |

检查各组是否具有偶数个1

- 第一组 H1、H3、H5、H7组：×，奇数个1
- 第二组 H2、H3、H6、H7组：√，偶数个1
- 第三组 H4、H5、H6、H7组：×，奇数个1

说明接收到的信息有出错位。

- 海明码如何确定出错位并纠错

对检错结果做进一步计算，交叉排查，即可定位具体出错位

由第二组结果可以确认H2、H3、H6、H7这四个位置正确，可疑出错位置是H1、H5、H4，

- 假设H1出错，则H5、H4正确，那么第三组应该有偶数个1，与检错结果矛盾，因此H1一定是正确的
- 假设H4出错，则H5正确，又因为H1一定正确，那么第一组应该有偶数个1，与检错结果矛盾，因此H4也一定是正确的
- 排除了H1、H4出错的可能性，最终确定是H5出错。

纠错：对出错位直接取反即可。

- 计算机构造海明码并确定出错位

以上都是手算，计算机里所有步骤都是用逻辑计算完成的。

设原二进制串为$D_4D_3D_2D_1$，校验位为$P_3P_2P_1$，海明码为$H_7H_6H_5H_4H_3H_2H_1$

- 逻辑计算确定校验位取值

  对校验位所负责的位进行异或 $$ P_1=D_1\bigoplus D_2\bigoplus D_4\ P_2=D_1\bigoplus D_3\bigoplus D_4\ P_3=D_2\bigoplus D_3\bigoplus D_4\ $$

- 逻辑计算确定出错位

  将各校验位与它们所负责的位一起异或 $$ S_1=P_1\bigoplus D_1\bigoplus D_2\bigoplus D_4\ S_2=P_2\bigoplus D_1\bigoplus D_3\bigoplus D_4\ S_3=P_3\bigoplus D_2\bigoplus D_3\bigoplus D_4\ $$ $S_3S_2S_1$即出错位号，如$S_3S_2S_1=000$时表示无错，$S_3S_2S_1=101$时表示海明码中位置$H_5$出错

- 海明距离

- 两个等长字符串的海明距离，是字符串中字符不同的位置个数。如10011、10010，只有最后一位不同，海明距离为1

- 海明码纠错d位，需要码距为 2d+1 的编码方案

  海明码检错d位，需要码距为 d+1 的编码方案

#### 局限

 若数据链路层仅采用 CRC ，那么只能保证对帧的**无差错接受**，即被接受的帧可以认为几乎没有差错，有差错的帧都已经被丢弃了，没有接受。注意，这没有实现可靠传输，因为它仅仅检测了比特差错这一种情况。传输过程还会出现其他差错，如帧失序、帧重复、帧丢失等，必须都具有应对手段才能说提供了可靠传输服务。

 对于通讯质量良好的有线传输链路，数据链路层**不向上提供可靠传输服务**；对于通讯质量较差的无线传输链路，数据链路层**向上提供可靠传输服务**。这样的区别对待可以提高通信效率。

## 四、流量控制与可靠传输机制

#### 流量控制

- 停止-等待流量控制

发送方每发送一帧，需要等待接收方的应答信号才能发送下一帧

传输效率很低。

- 滑动窗口流量控制

发送窗口：由发送方维持的一组连续的允许发送的帧的序号

接收窗口：由接收方维持的一组连续的允许接收的帧的序号

发送端每收到一个来自接收方的确认帧，发送窗口就向前滑动一个帧的位置。当发送窗口内的帧已经全部发送，但还未收到确认帧时，发送方停止发送，直到收到确认帧为止。

接收端收到帧后，将接收窗口向前滑动一个帧的位置，并发回确认帧。如果收到的帧序号在接收窗口允许的序号之外，则一律丢弃。

滑动窗口的特性：

- 只有接收窗口发送了确认帧并向前滑动，发送窗口才有可能向前滑动
- 从滑动窗口的角度来看：
  - 停止-等待协议：发送窗口=1，接收窗口=1
  - 后退N帧协议：发送窗口＞1，接收窗口=1
  - 选择重传协议：发送窗口＞1（序号的一半），接收窗口＞1（序号的一半）
- 当接收窗口大小为1时，可保证帧的有序接收
- 数据链路层的滑动窗口协议中，窗口大小在传输过程中固定。与传输层的滑动窗口协议有区别

#### 可靠传输机制

- 两种机制：确认和超时重传
- 确认：无数据的控制帧，可以捎带在回复帧中以提高传输效率，称为捎带确认
- 超时重传：发送方在发送某个数据帧后就开启一个计时器，若在一定时间内未收到所发帧的确认帧，则重发该帧
- 自动重传请求（ARQ）
- 接收方请求发送方重传出错的数据帧
- 分为三种：停止-等待ARQ、后退N帧ARQ、选择性重传ARQ。后两种又称为连续ARQ协议

#### 停止-等待协议

- 情况一：发送帧丢失或错误

发送方设置计时器，超时自动重传

- 情况二：发送帧正确到达，但确认帧被破坏

发送方一直收不到确认帧，自动重传，导致接收方会收到重复数据帧。

接收方丢弃重复数据帧，并重发该帧的确认帧。

- 若连续出现相同发送序号的数据帧：发送端进行了超时重传

若连续出现相同序号的确认帧：接收端收到了重复帧

- 发送方和接收方都须设置一个帧缓冲区

发送端在发送完数据帧后，在缓冲区中保留该帧副本以备重传。收到该帧确认帧后才清除副本

#### 后退N帧协议GBN

发送方连续发送帧（在发送窗口允许的范围内），接收方可以连续接收多个正确的帧后，再对收到的最后一个正确数据帧发送确认信息，表示该帧及之前的帧都已经正确收到。

若接收方收到乱序或出错的帧，则要求接收方重发最后一个被正确接收的数据帧后所有未被确认的帧，并且重新发送最近发送的一个确认帧。

如接收方收到1号、2号帧后，对2号帧发回确认，表示这两个帧都已正确收到。随后接收方收到了3号、4号、6号数据帧，出现乱序，则丢弃这三个帧，并要求接收方重新从3号帧开始传输，且还要再发送一次对2号帧的确认。

**编号与窗口大小问题：**

- 接收窗口为1，以保证按序接收数据帧。
- **若采用n比特对帧编号，则发送窗口的大小最大可以为2^n-1**。如果超过该值，则会造成接收方无法分辨新帧和旧帧。
- 如，使用3bit对帧编号，则编号为0~7。假设发送窗口为8，发送方A一口气将发送窗口内的0~7帧全部发送给B。若B全部成功接收，则会发回对帧7的确认报文，并期待收到第二批帧（编号也是0~7）。然而确认报文丢失了，A自动重传了第一批的0~7帧，则B会错误认为是第二批帧而接收，数据传输出错。
- 假设发送窗口为7，发送方A同样一口气将0~6帧全部发送给B，B发回对帧6的确认报文，并期待收到从帧7开始的第二批帧。确认报文丢失，A自动重传了0~6帧，而B期待的是帧7，从而重传的这些帧会被自动丢弃，不会导致数据传输出错。

传送效率分析：

- 能够连续发送数据帧，提高信道利用率
- 即使仅有一个帧出错，也要将未确认帧全部重传，又降低了信道利用率
- 综上，若信道传输质量很差导致误码率较大时，后退N帧协议不一定优于停止-等待协议。

#### 选择重传协议SR

设法只重传那些出错或者计数器超时的数据帧。

这要求接收窗口必须足够大，以便能先暂存发送序号不连续但仍处于接收窗口中的帧。等到所缺帧全部收到后再一并送交主机。

一旦接收方怀疑帧出错，就会发送一个否定帧NAK给发送方，要求发送方重传NAK中的指定帧。

**编号与窗口大小问题：**

- **发送窗口和接收窗口大小相同**，且为序号范围的一半。
- 如采用2bit对帧编号，则序号范围为4，发送窗口和接收窗口的大小应为2.

#### 信道利用率与信道吞吐率

- 信道利用率：是对发送方而言的，指发送方在一个发送周期内，有效地发送数据所需要的时间占整个发送周期的比率。

发送周期T：从开始发送数据到收到第一个确认帧，所经历的时间

发送方在T时间内发送L比特数据，发送方数据传输速率为C，则发送方用于发送有效数据的时间为L/C，信道利用率为 (L/C)/T。

- 信道吞吐率：信道利用率×发送方的发送速率

## 五、介质访问控制

多个结点共用同一条信道时，介质访问控制为使用介质的每个结点隔离来自同一信道上其他结点所传送的信号，以协调活动节点的传输

信道分配协议属于数据链路层的一个子层——介质访问控制（MAC）子层

### 5.1 信道划分介质访问控制

#### 频分多路复用（FDM）

将物理信道的总带宽分割成若干与传输单个信号带宽相同（或略宽）的子信道，每个子信道传输一种信号。

子信道的带宽可以不同，但总和必须不超过信道的总带宽。实际应用中为了防止子信道之间的干扰，相邻信道之间需要加入”保护频带“

优点：

- 充分利用了带宽，系统效率较高
- 技术比较成熟，实现也较容易
- 更适合传输模拟信号

#### 时分多路复用（TDM）

更适合传输数字信号

所用传输介质的性质：介质的位速率大于单个信号的位速率

将一条物理信道按时间划分为多个时间片，轮流分配给多个信号使用。

在某个时刻，时分多路复用信道上传送的仅是某一对设备之间的信号。在某段时间内，传送的是按时间分割的多路复用信号。

改进：统计时分多路复用，时间片按需动态分配，只有当终端有数据要传送时，才会分配到时间片，可以提高线路利用率

#### 波分多路复用（WDM）

光的频分多路复用，在一根光纤中传输多种不同波长（频率）的光信号。

#### 码分多路复用（CDM）

采用不同的编码来区分各路原始信号。既共享信道的频率，又共享时间。

即数据混在一起传输，到达后再进行区分。

- 码分多址（CDMA）

- 共用物理信道的每个站点被分配一个唯一的m位的码片序列。若站点需要发送1，则发送该码片序列；若站点需要发送0，则发送该码片序列的反码。

- 当有两个或多个站点同时发送时，各路数据在信道中线性相加

- 要求各站点的码片序列相互正交，以便分离信号

- 规格化内积：两个向量的内积除以向量的分量个数

- 码片向量与自身的规格化内积都是1，码片向量与自身反码的规格化内积是-1，不同站点的码片向量相互正交，规格化内积为0.

- eg：站点A的码片序列被指派为S：00011011（按惯例将0写为-1，将1写为+1，即-1 -1 -1 +1 +1 -1 +1 +1），站点B的码片序列被指派为T： -1 -1 +1 -1 +1 +1 +1 -1

  站点A向站点C发送1，同时站点B向站点C发送0，则信道上的向量为S-T：0 0 -2 2 0 -2 0 2

  C站要从中分离来自A站的向量，需要先知道A站的码片序列S，然后让S与S-T做规格化内积，得到（2+2+2+2）/8=1，因此知道A站发送的信号是1

  同理，分离来自B站的向量，让T与S-T做规格化内积，得到(-2-2-2-2)/8=-1，因此知道B站发送的信号是0

优点：

- 频谱利用率高、抗干扰能力强、保密性强、语音质量好
- 减少投资和降低运行成本，主要用于无线通信系统，特别是移动通信系统

### 5.2 随机访问介质访问控制

#### ALOHA协议

- 纯ALOHA协议
- 站点想发就发，不需要任何检测。过一段时间没收到确认就认为发生了冲突，等一段时间后再发，知道发送成功
- 重传策略：各站等待一段随机的时间后再重传
- 吞吐量很低
- 时隙ALOHA协议
- 将各站在时间上同步起来，并将时间划分为一段段等长的时隙，规定时隙开始时才能发送一个帧，且时隙的长度能保证一个帧恰好在一个时隙内发送完毕
- 减少了冲突的可能性，提高信道利用率
- 较纯ALOHA协议相比，吞吐量扩大了一倍

#### CSMA协议

在ALOHA协议上改进，增加了载波侦听装置，以便在发送之前侦听信道是否空闲。

- 1-坚持CSMA
- 要发送数据时先侦听信道，若信道空闲则立即发送，否则等待并继续侦听直到信道空闲
- 若发生冲突，则随机等待一段时间后再侦听信道
- ”1-坚持“：即侦听到信道忙后仍坚持侦听，且侦听到信道空闲时发送数据的概率为1，即立即发送数据。
- 传播延迟对1-坚持CSMA的性能影响较大。
- 即使不考虑传播延迟，也可能发生冲突。如有两个站点同时在等待信道空闲时
- 非坚持CSMA
- 要发送数据时先侦听信道，若信道空闲即立即发送，否则放弃侦听，等待一个随机的时间后再重复以上过程
- 降低了冲突概率，但增加数据在网络中的平均延迟
- p-坚持CSMA
- 要发送数据时先侦听信道，若信道忙则坚持侦听，若信道空闲，则以概率p发送数据，以概率1-p推迟到下一个时隙。该概率固定。
- 是非坚持CSMA与1-坚持CSMA的折中方案

#### CSMA/CD协议

- 前置概念
- 多点接入：总线型网络，所有计算机连接在一根总线上
- 载波监听：实质上是媒介监听，即发送数据前和发送数据中都不停地检测信道是否有其他主机发送数据（注意，没有发送完毕之后的检测，这会造成问题，具体见下），如果有，立即中止本站的发送
- 碰撞检测
- 争用期

**至多**经过多久后站点得知自己发送的数据是否发生碰撞。最坏情况下，两站点位于总线的两端（距离最远），站点发出的数据帧在将到达目的站点时（此时已经过了时间$\tau$，$\tau$为总线传播时延），目的站点恰好发出数据，发生碰撞，碰撞信息再经过时间$\tau$回传给站点。故从站点发送数据开始计时，最多经过时间$2\tau$，站点可得知自己发送的数据是否发生碰撞。

这个时间$2\tau$即争用期/碰撞窗口。一个站点发出的数据要经过争用期的“考验”，才能确定是否到达目的站点，若过了争用期还没有发生碰撞，则本次传输的数据都不会发生碰撞。

- 如果碰撞，何时重传？
- 截断二进制指数退避算法，使得发生碰撞的站在等待一个随机的时间后再发送数据。
- 算法规定，基本退避时间为争用期$2\tau$，具体的争用期时间为$51.2\mu s$，对于速率为10Mbit/s的以太网，在争用期内可发送512bit，即64字节（如果一切顺利没有发生碰撞）
- 定义重传次数k，**但k=min[重传次数，10]，即当重传次数达到10次后，k一直为10，不再增大**
- 从离散的整数集合[0,1,...,2^k-1]中随机取出一个数r，则重传所需要退避的时间为$2r\tau$
- 若重传16次仍未成功，说明网络太拥挤，抛弃此帧并向高层报告出错。
- 无效帧
- 问题：上述假设的情况有一个前提：在发生碰撞时，站点仍在发送数据。这种情况下，发送站能检测到碰撞。但如果数据量非常小，且发送完毕前没有检测到碰撞，在发送完毕之后，这个数据量很小的帧又在传播过程中发生了碰撞，则发送站无从知晓（因为已经发送完了，不检测）这个帧是否正确到达了目的站点。
- 解决：规定一个最短帧长64字节，若数据量小于64字节则进行填充以达到要求。根据前文，争用期内可发送64字节，若发生碰撞，一定会在前64字节内。将最短帧长规定为64字节，即可保证发生碰撞时站点仍在发送数据，从而站点可检测到碰撞。
- 站点一旦检测到碰撞立即终止发送，则已经发送的数据一定小于64字节，那么根据最短帧长限制，可以认为小于64字节的数据都是发生了碰撞的无效数据，即**无效帧**，直接丢弃即可
- 以太网的实际端对端长度

争用期时间51.2$\mu s$是个规定值，这意味着投入使用的以太网总线的传播时延应该小于争用期的一半25.6$\mu s$。已知信号在以太网上传播1km需要5$\mu s$，要符合上述传播时延要求，以太网的最大端对端长度应不大于5km。而实际投入使用的以太网覆盖范围远远没有这么大，即使算上转发器等造成的时延，也是能符合争用期时间要求的。

- 强化碰撞

- 目的：当发送碰撞时，除了发送站能检测到发生碰撞，也要使总线上的其他站点也能检测到发生碰撞

- 方法：发送站检测到发生碰撞，立即停止发送数据，转而发送人为干扰信号（32bit或48bit，对于速率为10Mbit/s的以太网，发送时间为3.2$\mu s$或4.8$ \mu s$）

- 信道占用时间：假设发送数据后经过时间$T_B$检测到发生碰撞并停止发送，再经过时间$T_J$将人为干扰信号发送完毕，人为干扰信号再经过传播时延$ \tau$传播到整个总线，因此总的占用时间为$T_B+T_J+\tau$

- 帧间最小间隔

- 目的：留给接收站处理帧数据的时间

- 值：9.6$ \mu s$

- CSMA/CD 协议要点

- 准备发送

  适配器按数据链路层要求将网络层数据封装成以太网帧（以太网帧格式见后文），放入适配器缓存，并检测信道。

- 检测信道

  检测到信道忙，则一直检测直至信道空闲，由于帧间最小间隔的存在，在检测到信道空闲后还需要继续确认持续9.6$\mu s$的空闲状态，然后再发送数据。

- 边发送边监听

  - 情况1：争用期内未检测到碰撞，视为数据发送成功，什么都不做，回到1
  - 情况2：争用期内检测到碰撞，立即中止发送，并发送人为干扰信号。然后执行指数退避算法，回到2尝试重传。若重传达16次仍未成功，则停止重传，向上报错。

#### CSMA/CA协议

- 应用于无线局域网。与CSMA/CD相比，还需要解决两个问题：

- 接收信号的强度往往远小于发送信号的强度，且信号强度动态变化范围很大，碰撞检测实现成本高，因此不进行碰撞检测

- 并非所有的站点都能听见对方，即存在”隐蔽站“的问题

- CA意指”碰撞避免“，表明协议应尽量降低碰撞发生的概率。

- 碰撞避免技术：

- 802.11规定每个站发送后，必须等待一段很短的时间才能发送下一帧。这段时间称为帧间间隔IFS。IFS长短取决于该站要发送的帧的类型

- SIFS（短IFS）：最短的IFS，用于分隔属于同一次对话的各个帧。使用的有ACK帧、CTS帧、分片后的数据帧、所有回答AP探询的帧等

- PIFS（点协调IFS）：中等长度的IFS，在PCF操作中使用

- DIFS（分布式协调IFS）：最长的IFS，用于异步帧竞争访问的时延

- CSMA/CA算法流程：

- 若站点的数据是第一次发送（而不是重传的数据），且检测到信道空闲，则等待DIFS后，发送整个数据帧

- 否则，站点执行CSMA/CA退避算法，选取一个随机回退值。若信道忙，则退避计时器保持不变，若信道空闲，退避计时器进行倒计时

- 当退避计时器减到0时（此时信道一定是空闲的），站点发送整个帧并等待确认

- 若收到确认，说明已经被正确接收。若要发送第二帧，则需要从步骤2开始

- 若未收到确认，则必须重传该帧，再次使用CSMA/CA协议争用信道。若若干次重传仍失败，放弃发送

- 隐蔽站问题：RTS帧和CTS帧

- 隐蔽站：站A和站B都在同一个AP的覆盖范围内，但A和B相距较远，彼此都听不见对方，容易同时发送数据造成碰撞

  ![image-20221127151655952](https://streamazure.github.io/Computer_Basics_Notes/Computer_Network_Notes/0x03%20%E6%95%B0%E6%8D%AE%E9%93%BE%E8%B7%AF%E5%B1%82/image-20221127151655952.png)

- RTS（请求发送）控制帧：用于发送站预约信道，包括源地址、目的地址和此次通信（含相应确认帧）所持续的时间，该帧能被其范围内包括AP的所有站点听到

- CTS（允许发送）控制帧：用于AP许可信道使用权并抑制其他站点发送，包括此次通信所持续的时间（复制自RTS），该帧能被其范围内包括A和B的所有站点听到。B和其他站点收到CTS后，在指明时间段内抑制发送，从而确保信道为受许可的站点专用。

- 信道预约机制：

  1. 发送站先广播一个RTS控制帧
  2. AP收到该RTS帧。若信道空闲，则广播一个CTS帧
  3. A使用信道发送数据；A以外的其他站点均抑制发送

- 使用RTS和CTS会使网络通信效率有所下降，但RTS和CTS很短，开销相比碰撞重发而言可以接受。

- 信道预约不是强制性规定，各站可以自行决定是否使用。

- 当数据帧长超过某一数值时，使用RTS和CTS才比较有利。（否则很短的数据帧还不如直接重传更快）

#### CSMA/CD与CSMA/CA的区别

|              | CSMA/CD                                            | CSMA/CA                                    |
| :----------- | :------------------------------------------------- | :----------------------------------------- |
| **基本思想** | 发送前侦听，边发送边侦听，一旦出现碰撞立即停止发送 | 发送前预约信道，避免出现碰撞               |
| **冲突检测** | 可以检测冲突，但无法避免                           | 无法在发送数据的同时检测冲突，只能尽量避免 |
| **传输介质** | 用于总线形以太网                                   | 用于无线局域网 802.11a/b/g/n               |
| **检测方式** | 通过电缆中的电压变化                               | 能量检测、载波检测、能量载波混合检测       |

#### 轮询访问：令牌传递协议

- 设置一个集中控制的监控站，该站轮询每个结点，再决定信道的分配。
- 在令牌传递协议中，一个令牌（Token）沿着环状总线在各结点计算机间依次传递。令牌是一个特殊的MAC控制帧，它本身不包含信息，仅控制信道的使用
- 传输过程：
- 收到令牌的站点才可以启动发送帧，即修改令牌的标志位，并在令牌中附加自己需要传输的数据及目的站点地址，使令牌变成一个数据帧再发送出去
- 目的站点地址复制该数据帧以便进一步处理
- 数据帧继续传输，直到到达源站点。源站点不再转发该数据帧，同时检查返回的帧以确定是否出错。
- 源站点重新产生一个令牌，并传递给下一个站点。
- 若站点都不需要发送数据，则令牌在环形网上游荡。
- 要求多个站点之间的传递通路在逻辑上是一个环（物理上不必是）
- 非常适合负载很高的广播信道（即多个结点在同一时刻发送数据概率很大的信道）
- 既不共享时间、也不共享空间

## 六、局域网

### 6.1 局域网的基本概念和体系结构

#### 局域网的定义

- 网络为一个单位所拥有，且地理范围和站点数目均有限
- 具有**广播功能**，局域网上的主机可以共享连接在局域网上的各种硬件和软件资源

#### 局域网的特性

- 局域网的特性由三个要素决定：拓扑结构、传输介质、介质控制方式。其中最重要的是介质控制方式，决定着局域网的技术特性
- 常见拓扑结构：星形网（使用集线器）、环形网、总线网、星形和总线形结合的复合型结构
- 常用传输介质：双绞线（主流）、铜缆、光纤等
- 介质访问控制方法：CSMA/CD、令牌总线、令牌环。其中前两种方法用于总线形局域网，令牌环用于环形局域网

### 6.2 以太网与IEEE 802.3

#### 以太网的网络拓扑

- 以太网使用集线器（hub）构成星形拓扑，在物理上是个星形网。集线器使用电子器件模拟实际电缆的工作，使得在逻辑上是个总线网，各站共享逻辑上的总线。
- 各站中的适配器执行CSMA/CD协议。同一时刻至多允许一个站发送数据。
- 集线器有许多端口，每个端口用 2 对双绞线与一台计算机的适配器相连
- **集线器工作在物理层**，每个端口仅仅是简单地转发比特，不进行碰撞检测。
- 光纤主要用于集线器之间的远程连接

#### 以太网的简化通信措施

1. 采用无连接工作方式，不对数据帧编号、不要求确认，尽最大努力交付
2. 发送数据使用曼彻斯特编码，每个码元中间出现一次电压转换，接收端利用这种电压转换提取位同步信号

#### 以太网的传输介质与网卡

以太网的传输介质有4种：粗缆、细缆、双绞线和光纤

（下表必背！！）

| 参数       | 10BASE5        | 10BASE2        | 10BASE-T     | 10BASE-FL    |
| :--------- | :------------- | :------------- | :----------- | :----------- |
| 传输媒体   | 同轴电缆－粗缆 | 同轴电缆－细缆 | 非屏蔽双绞线 | 光纤对       |
| 编码       | 曼彻斯特编码   | 曼彻斯特编码   | 曼彻斯特编码 | 曼彻斯特编码 |
| 拓扑结构   | 总线形         | 总线形         | 星形         | 点对点       |
| 最大段长   | 500m           | 185m           | 100m         | 2000m        |
| 最多结点数 | 100            | 30             | 2            | 2            |

- 计算机与外界局域网的链接通过适配器，即网卡实现。网卡是工作在链路层的网络组件。另外，网卡控制着主机对介质的访问，因此网卡也工作在物理层。
- 适配器的一个重要功能是进行数据串行传输和并行传输的转换（对内通过I/O总线并行传输，对外通过电缆、双绞线串行传输）
- 计算机的**硬件地址**存储在适配器的ROM中，IP存储在计算机存储器中

#### 以太网的信道利用率

（1）提高信道利用率所要做到的

假设发送一个帧所需的时间为$T_0$，则成功发送一个帧（即对方成功收到）需要占用信道的时间为$T_0+\tau$。 $$ a = \frac{\tau}{T_0} $$ 当$a\rightarrow0$时，只要一发生碰撞就会被立即检测到。$a$越大，则争用期占比越大，只要发生一次碰撞就会浪费不少的信道资源。因此$a$应该尽量小。

为使得$a$尽量小，一方面要使得$\tau$尽量小，即数据率一定时，**以太网的连线的长度有限**（减小传播时延）；另一方面要使得$T_0$尽可能大，即**以太网的帧长不能太短**。

（2）极限信道利用率

最理想化情况下，以太网上的数据不会发生碰撞，且一有空闲立即发送数据，那么此时的信道利用率为 $$ S_{max} = \frac{T_0}{T_0+\tau} =\frac{1}{1+a} $$ 上式表明，只有当$a$远小于1时，极限信道利用率才会尽可能高。

#### 以太网的MAC帧格式

（1）MAC地址

- 48位（6字节），固化在适配器的ROM中
- 最低第1位为I/G位（Individual/Group），为0时，该地址表示单个站地址；为1时表示组地址
- 最低第2位为G/L位（Global/Local），为0时，全球管理，保证全球唯一；为1时本地管理，用户可任意分配
- 全1，广播地址

（2）帧格式

![image-20221115205253726](https://streamazure.github.io/Computer_Basics_Notes/Computer_Network_Notes/0x03%20%E6%95%B0%E6%8D%AE%E9%93%BE%E8%B7%AF%E5%B1%82/image-20221115205253726.png)

- 不算MAC帧的部分：硬件生成的8个字节，前7个为前同步码，用于接收方适配器调整时钟频率；最后1个为帧开始定界符，值为10101011，前六位作用与前同步码一样，最后两个1通知适配器MAC帧即将到达。
- 首部字段1：6字节，目的地址
- 首部字段2：6字节，源地址
- 首部字段3：2字节，类型，标志上一层使用的协议类型
- 数据字段：长度范围[46，1500]；最小值46字节=最小总帧长64字节-14字节的首部-4字节的尾部；最大值即MTU值。当数据字段过短导致总帧长小于64字节时，在数据字段的末尾填充。
- 尾部字段：4字节，CRC检验得出的帧检验序列FCS，其检验范围从目的地址字段开始，到FCS本身结束。
- 注意，MAC帧不需要帧结束符，因为以太网在传输帧时，要求各帧之间必须有一定的间隙。

（3）无效MAC帧

- 数据字段的长度与长度字段的值不一致；
- 帧的长度不是整数个字节；
- 用收到的帧检验序列 FCS 查出有差错；
- 数据字段的长度不在 46 ~ 1500 字节之间。
- 有效的 MAC 帧长度为 64 ~ 1518 字节之间。

（4）无效MAC帧的处理方式

**直接丢弃。**

#### 高速以太网

速率≥100Mbit/s的以太网称为高速以太网

- 100BASE-T以太网（快速以太网）：
- 在双绞线上传送 100 Mbit/s 基带信号的星形拓扑以太网，仍使用 IEEE 802.3 的 CSMA/CD 协议。
- 既支持全双工，又支持半双工，可以在全双工方式下工作而无冲突发生。
- 吉比特以太网/千兆以太网：
- 1Gbit/s
- 全双工和半双工两种方式
- 适用802.3协议规定的帧格式。在半双工下使用CSMA/CD协议，而全双工下不需要使用该协议
- 10吉比特以太网：
- 不再使用铜线而只使用光纤
- 只工作在全双工方式，没有争用问题，也不使用CSMA/CD

### 6.3 IEEE 802.11 无线局域网

#### 无线局域网的分类

- 有固定基础设施的无线局域网
- 星型拓扑，其中心称为接入点AP
- 在MAC层使用CSMA/CA协议
- 最小构件：基本服务集BSS
  - 包含一个AP和若干移动站
  - 各站在BSS内之间的通信，或与外部站之间的通信，都必须通过本BSS的AP
  - AP具有一个不超过32字节的服务集标识符和一个信道。
- 一个基本服务集覆盖的地理范围称为一个基本服务区BSA，一般直径不超过100m
- 一个基本服务集可以是孤立的，也可通过AP连接到一个分配系统，再连接到另一个基本服务集从而构成扩展服务集ESS。
- ESS可以通过一种叫门户的设备接入到有线以太网
- 无固定基础设施的移动自组织网络
- 没有AP，各结点之间地位平等，中间结点都为转发结点，都具有路由器功能
- ![image-20221116104115326](https://streamazure.github.io/Computer_Basics_Notes/Computer_Network_Notes/0x03%20%E6%95%B0%E6%8D%AE%E9%93%BE%E8%B7%AF%E5%B1%82/image-20221116104115326.png)
- 可以具有自己特定的路由选择协议，可以不与因特网相连

#### 802.11局域网的MAC帧

分为数据帧、控制帧和管理帧。下面只介绍数据帧

- 帧结构

![image-20221116105847224](https://streamazure.github.io/Computer_Basics_Notes/Computer_Network_Notes/0x03%20%E6%95%B0%E6%8D%AE%E9%93%BE%E8%B7%AF%E5%B1%82/image-20221116105847224.png)

- MAC首部，30字节
  - 2字节帧控制字段，包含“去往AP”位和“来自AP”位
  - 2字节持续期字段，2字节序号控制字段
- 4个6字节地址字段，均为MAC地址，其中地址4用于自组网络。地址1总是为帧的接收地址，地址2总是为帧的发送地址，而地址3根据帧的去向变化，若帧去往AP，则地址3为目的地址；若帧去往目的站，则地址3为源地址
- 帧主体，不超过2312字节，比以太网的最大长度长很多
- FCS尾部，4字节
- 同一个BSS内的转发流程

![image-20221116104636443](https://streamazure.github.io/Computer_Basics_Notes/Computer_Network_Notes/0x03%20%E6%95%B0%E6%8D%AE%E9%93%BE%E8%B7%AF%E5%B1%82/image-20221116104636443.png)

1. 假设站A和站B在同一个基本服务集中，则它们相互之间的通信都要经过该基本服务集的AP

2. 站A向站B发送数据帧。该帧首先会发往AP。此时帧的首部中，“去往AP”=1，“来自AP”=0，地址1是AP的MAC地址，地址2是A的MAC地址，地址3是B的MAC地址。

   此时该帧的【接收地址】为AP的MAC地址；而【目的地址】为B的MAC地址

3. AP将该帧转发给站B。此时帧的首部中，“去往AP”=0，“来自AP”=1，地址1是B的MAC地址，地址2是AP的MAC地址，地址3是A的MAC地址。

   此时该帧的【接收地址】为B的MAC地址；而【目的地址】也为B的MAC地址

4. 不同BSS、经过路由器的转发流程

5. 假设站A在BSS1中，站B在BSS2中，两个BSS的AP通过有线连接到路由器。

6. 路由器要向站A发送数据。它从IP数据报中获知A的IP地址，从而使用ARP获取站A的MAC地址。

7. 路由器接口R1（连接AP1）将该IP数据报封装成802.3帧（因为路由器与AP之间是有线以太网连接），其源地址为R1的MAC地址，目的地址为A的MAC地址.

8. AP将该帧转换为802.11帧，并将帧首部设置如下：“去往AP”=0，“来自AP”=1；地址1为A的MAC地址（接收地址），地址2为AP的MAC地址（发送地址），地址3为R1的MAC地址（源地址）。

### 6.4 虚拟局域网

（1）VLAN 标签

- 在以太网帧格式，源地址字段之后、类型字段之前插入一个4字节的字段，作为VLAN标识符。
- 拥有VLAN标识符的以太网帧称为802.1Q帧
- VLAN标识符前2字节为固定的0x8100，后2个字节的前4位无用，后12位为VID
- 插入VLAN标签后，需要重新计算FCS
- 由于多加了VLAN标识符，802.1Q帧的最大帧长变为1522字节（18字节首部+4字节尾部+1500数据部分）

（2）工作过程

![image-20221116094410056](https://streamazure.github.io/Computer_Basics_Notes/Computer_Network_Notes/0x03%20%E6%95%B0%E6%8D%AE%E9%93%BE%E8%B7%AF%E5%B1%82/image-20221116094410056.png)

1. 假设主机A、主机E分别接入两个交换机#1和#2，同属一个虚拟局域网VLAN10.
2. 当主机A向主机E送以太网帧时，#1给来自主机A的以太网帧插入VLAN标签，通过汇聚链路发送到#2；#2收到带有VLAN标签的以太网帧，取走VLAN标签后再转发给主机E。

（3）细节

1. **既可以隔离冲突域，也可以隔离广播域**
2. VLAN只是局域网给用户提供的一种服务，并不是一种新型局域网
3. 主机与交换机之间交互的都是标准以太网帧，VLAN标签由交换机插入，也由交换机取走。
4. 各主机并不知道自己的VID值，交换机必须知道。

## 七、广域网

### 7.1 广域网基本概念

#### 广域网的定义与任务

- 广域网是覆盖范围很广（远超一个城市）的长距离网络。
- 是因特网的核心部分
- 任务是长距离运送主机所发送的数据
- 首要考虑问题：足够大的通信容量

#### 广域网与互联网的区别

- 互联网可以连接不同类型的网络，包括局域网和广域网，通过路由器连接
- 路由器在多个网络构成的互联网中转发分组
- 广域网由一些结点交换机及连接这些交换机的链路组成
- 结点交换机在单个网络中转发分组
- 结点之间是点到点连接，但为了提高网络可靠性，一个结点交换机往往与多个结点交换机连接

#### 广域网与局域网的区别

![image-20221115232906360](https://streamazure.github.io/Computer_Basics_Notes/Computer_Network_Notes/0x03%20%E6%95%B0%E6%8D%AE%E9%93%BE%E8%B7%AF%E5%B1%82/image-20221115232906360.png)

### 7.2 点对点协议 PPP

#### PPP 协议特点

（1）应满足的需求

- 简单
- 封装成帧
- 透明传输
- 差错检测
- 多种网络层协议
- 多种类型链路（串行的或并行的，同步的或异步的，电的或光的，低速的或高速的点对点链路）
- 检测连接状态：PPP 需要具备对链路工作状态的及时检测功能
- 最大传输单元
- 网络层地址协商：必须提供一种机制使得两个网络层的实体可以互相知道网络层地址
- 数据压缩协商：必须提供一种机制协商数据压缩算法

（2）组成

- 一个将IP数据报封装到串行链路的方法
- 链路控制协议LCP，用于建立、配置和测试数据链路连接
- 网络控制协议NCP，用于支持不同的网络层协议

（3）其他

- PPP没有纠错功能，只保证无差错接收。是不可靠的传输协议，不使用序号和确认机制。
- 仅支持点对点的链路通信，不支持多点线路
- 只支持全双工链路
- PPP的两端可以运行不同的网络层协议，但仍然可使用同一个PPP进行通信。

#### PPP 协议格式

（1）信息部分

- 通常为网络层交付的IP数据报
- 长度可变但有上限，上限称为MTU，默认1500字节。
- PPP是点对点而非总线形，因此不采用CSMA/CD协议，从而没有最短帧的规定，因此信息部分的字节数最小可以是0

（2）首部

首部的第1个字段（1字节）为标志字段，表示一个帧的开始，值规定为0x7E

首部的第2、3个字段（各1字节）为地址字段和控制字段，值分别规定0xFF和0x03，保留字段，无意义

首部的第4个字段（2字节）为协议字段，表示该帧信息字段的协议类型

（3）尾部

尾部的第1个字段（2字节）为使用CRC的帧检验序列FCS

（4）填充

异步传输时，使用**字节填充**。转义符为0x7D，填充方法如下：

- 信息字段中的0x7E字节转变为0x7D,0x5E
- 信息字段中的0x7D字节转变为0x7D,0x5D
- 其他ASCII码的控制字符，在前面加入0x7D，同时该字符编码改变

同步传输时，使用**零比特填充**。发送端扫描整个信息字段（通常用硬件实现），在每五个连续的1后填入一个0，使信息字段中不会出现连续的六个1。

#### PPP协议工作过程

**（链路静止状态）**用户拨号接入ISP → 建立物理连接**（链路建立状态）**

**（链路建立状态）**用户发送LCP分组（被封装为多个PPP协议帧） →　建立LCP连接**（鉴别状态）**

**（鉴别状态）**只允许传送LCP协议分组、鉴别协议分组、监测链路质量的分组；口令鉴别协议PAP与更复杂的口令握手鉴别协议CHAP。鉴别失败则转入**（链路终止状态）**，成功则转入**（网络层协议状态）**

**（网络层协议状态）**根据PPP链路上运行的协议类型，使用NCP中的对应支持协议进行配置，如IP协议对应的是IP控制协议IPCP，配置双方的IP协议模块（如分配IP地址） **（链路打开状态）**

**（链路打开状态）**关闭请求或链路故障**（链路终止状态）**

**（链路终止状态）**LCP链路终止，即调制解调器的载波停止**（链路静止状态）**

## 八、数据链路层设备

### 8.1 网桥

- 通过网桥连接的多个以太网各自成为一个网段
- 网桥工作在数据链路层的MAC子层，可以使各网段成为隔离开的碰撞域
- 网桥具备路径选择功能。网桥接收来自网段1的数据帧，检查帧中地址，若是网段2的地址，则转发到网段2；若是网段1的地址，则直接丢弃，因为目标站可以直接收到该帧，不需要网桥

### 8.2 局域网交换机

#### 工作原理与特点

- 交换机是一个多端口网桥，工作在数据链路层
- 在有N个用户的使用交换机的10Mb/s的共享式以太网中，每个用户在通信时是独占，因此拥有N对端口（注意是对不是个）的交换机的总容量为N×10Mb/s
- 对工作站透明，管理开销低廉。
- 可以方便地实现虚拟局域网VLAN。
- 特点：
- 每个端口都直接与单台主机相连（而不是一个网段），一般工作在全双工方式
- 能同时连通多对端口，使每对相互通信的主机能无碰撞地传输数据
- 是一种即插即用设备，内部的帧转发表通过自学习算法自动建立
- 使用专用的交换结构芯片，交换速率较高
- 以太网交换机独占传输媒体的带宽
- 交换模式：
- 直通式交换机，只检查帧的目的地址，帧在接收后几乎马上被传出去。但无法支持具有不同速率的端口的交换
- 存储转发式交换机，先将接收到的帧缓存在高速缓存器中，并检查数据是否正确，正确则转发，否则丢弃。可靠性高，能支持不同速率端口间的转换，缺点是延迟较大

#### 自学习功能

交换表：表项包含MAC地址、连通该MAC地址的交换机接口。

交换表的每个表项都设有一定的有效时间，过期表项自动删除，以保证交换表中数据符合当前网络的实际状况。

自学习过程：

1. 初始时交换表为空。
2. 连接交换机接口1的主机A向连接交换机接口3的主机B发送一帧，该帧从接口1进入交换机。
3. 交换机查找交换表，找不到主机B的对应表项，向除了接口1以外的所有接口广播这个帧
4. 其他接口丢弃该帧，而B收下该帧
5. 交换机将（A，1）写入交换表，表示发往主机A的帧都应从接口1转发出去。

### 8.3 冲突域和广播域

物理层设备（如集线器）既不能隔离冲突域，也不能隔离广播域

数据链路层设备（如交换机）可以隔离冲突域，但不能隔离广播域

网络层设备（如路由器）既可以隔离冲突域，又可以隔离广播域

# chap4 网络层

## 一、网络层功能

### 1.1 异构网络互联

网络互联：指用路由器进行网络互联和路由选择。

虚拟IP网络：使用相同IP协议参加互联的计算机网络，屏蔽了各物理网络的异构性，看上去好像是一个统一的网络。

### 1.2 路由与转发

路由选择：按照复杂的分布式算法，根据从各相邻路由器所得到的关于整个网络拓扑的变化情况，动态地改变所选择的路由

分组转发：路由器根据转发表将用户的IP数据报从合适的端口转发出去

### 1.3 SDN

- 传统互联网：路由器既有转发表（数据层面）又有路由选择软件（控制层面），即路由器既要负责与其他路由器交换路由信息、动态改变路由，又要负责转发数据
- SDN是一种新型网络体系结构

#### SDN（软件定义网络）

在网络的控制层面设置一个逻辑上的远程控制器，掌握各主机和整个网络的状态，并为每个分组计算出最佳路由，再将**转发表下发**给路由器。从而，路由器只需要负责数据层面的工作，即收到分组、查找转发表、转发分组。

- 在这种模式下，网络变成了集中控制的，但这并不意味着SDN要将整个互联网改造成集中控制的。SDN适用于一些大型数据中心之间的广域网，可以提高网络运行效率。
- 基于流的转发
- 数据层面与控制层面分离
- SDN具有很好的可编程性

![image-20221210120153320](https://streamazure.github.io/Computer_Basics_Notes/Computer_Network_Notes/0x04%20%E7%BD%91%E7%BB%9C%E5%B1%82/image-20221210120153320.png)

#### OpenFlow

是SDN体系结构中控制层面和数据层面之间的通信接口，使得控制层面的控制器可以对数据层面中的物理设备进行直接访问和控制。

SDN并未规定必须使用OpenFlow，只是大多数SDN都使用OpenFlow

OpenFlow交换机可处理的帧：数据链路层的帧、网际层的IP数据报、传输层的TCP/UDP报文

#### 流表

对应传统路由器的路由表，但与路由表有区别。

- 流：穿过网络的一种分组序列，每个分组都共享首部某些字段的值，如某个流可以是具有相同源IP地址和目的IP地址的一连串分组
- 流表：SDN远程控制器来管理的
- 每个OpenFlow交换机有一个或多个流表，每个流表可以包含多个流表项

![image-20221210115543892](https://streamazure.github.io/Computer_Basics_Notes/Computer_Network_Notes/0x04%20%E7%BD%91%E7%BB%9C%E5%B1%82/image-20221210115543892.png)

- 首部字段值包含一组字段，用于匹配分组

- 既有MAC首部，又有IP首部，还有TCP/IP首部

  ![image-20221210115749372](https://streamazure.github.io/Computer_Basics_Notes/Computer_Network_Notes/0x04%20%E7%BD%91%E7%BB%9C%E5%B1%82/image-20221210115749372.png)

- 交换机可采用的动作有

  - 将分组从对应端口转发出去
  - 丢弃分组
  - 复制分组并从多个端口转发出去
  - 重写分组的首部字段（三层协议的首部都可重写）

#### 优点

- 全局集中式控制和分布式高速转发，既利于控制层面的全局优化，又利于高性能的网络抓饭
- 灵活可编程与性能的平衡，控制和转发功能分离后，使得网络可以由专有的自动化工具以编程方式配置
- 降低城北，实现了网络设备的制造与功能软件的开发相分离

#### 问题

- 集中管理易受攻击，若崩溃则整个网络都受影响
- 瓶颈问题，网络规模扩大，控制器可能称为网络性能的瓶颈

### 1.4 拥塞控制

拥塞判断：观察网络吞吐量与网络负载

- 轻度拥塞：随着网络负载的增加，网络吞吐量明显小于正常吞吐量
- 拥塞状态：网络吞吐量随着网络负载的增大而下降
- 死锁状态：网络吞吐量下降到零

拥塞控制：

- 开环控制：设计网络时事先将有关因素考虑周到。是一种静态预防方法。在做决定时不考虑当前网络状态
- 闭环控制：采用检测网络系统监视并及时检测哪里发生了拥塞，将拥塞信息传到合适的地方以便调整网络系统的运行。是基于反馈环路的概念，是一种动态的方法。

拥塞控制与流量控制的区别：

- 流量控制是指发送端与接收端之间点对点通信量的控制，只需要抑制发送方的发送速率
- 流量控制必须要确保通信子网能够传送待传送的数据，是一个全局性的问题，涉及网络中所有的主机、路由器及导致网络传输能力下降的所有因素

## 二、网络层设备

### 2.1 冲突域与广播域

- 冲突域：连接到同一物理介质上的所有结点的集合，结点之间存在介质争用的现象。
- 集线器、中继器等不能划分冲突域
- 网桥、交换机、路由器等可以划分冲突域
- 广播域：接收同样广播消息的结点集合。
- 集线器、交换机等设备所连接的结点都属于同一个广播域
- 路由器可以划分广播域

### 2.2 路由器的组成和功能

#### 路由器

- 路由器是一种具有多个输入/输出端口的专用计算机，用于连接异构网络并完成路由转发。多个广播域互联时必须使用路由器。
- 路由器的功能：路由选择、分组转发
- **一个存储转发设备实现了某一层功能，则意味着它可以互联该层及该层以下使用不同协议的两个网段。**
- 路由器实现了网络层功能，意味着路由器可以互联两个网络层、数据链路层、物理层协议都不同的网段。
- 网桥实现了数据链路层功能，意味着网桥可以互联两个数据链路层、物理层协议都不同的网段，但要求网络层及以上层次的协议要相同。
- 中继器实现了物理层功能，但它不是存储转发设备，互联的两个网段物理层协议必须相同。
- 直接交付：若目的主机和源主机位于同一个网络上，则数据报无须经过路由器
- 间接交付：目的主机和源主机位于不同网络上，数据报需要经过路由器选择路由转发给下一个路由器
- 路由器是面向协议的，依据网络地址进行操作，一般提供对多种协议的支持，如OSI、TCP/IP、IPX等。而网桥与高层协议无关。

#### 路由选择与分组转发

- 路由选择部分也称为控制部分
- 构成：路由选择处理机、路由表、路由选择协议
- 核心构件：路由选择处理机
- 任务：根据所选定的路由选择协议构造路由表，定时或经常地与相邻路由器交换路由信息而不断更新和维护路由表
- 分组转发部分
- 构成：交换结构、一组输入端口、一组输出端口
- 处理流程：
  - 输入端口从在物理层接收到的比特流中提取出数据链路层帧，进而从帧中提取出网络层数据报
  - 输出端口与输入端口操作相反
  - 交换结构根据转发表对分组进行处理，将来自输入端口的分组从一个合适的输出端口转发。有三种常用交换方法：通过存储器交换、通过总线交换、通过互联网络交换
- 交换结构本身就是一个网络

### 2.3 路由表与转发表

#### 路由表

路由表根据路由选择算法得出，通常具有4个项目：目的网络IP地址、子网掩码、下一跳IP地址、接口.

例如，对于图中的网路拓扑：

![image-20221117161808020](https://streamazure.github.io/Computer_Basics_Notes/Computer_Network_Notes/0x04%20%E7%BD%91%E7%BB%9C%E5%B1%82/image-20221117161808020.png)

R1的路由表如下：

| 目的网络IP地址 | 子网掩码      | 下一跳IP地址 | 接口 |
| :------------- | :------------ | :----------- | :--- |
| 202.114.1.0    | 255.255.255.0 | Direct       | E1   |
| 202.114.2.0    | 255.255.255.0 | Direct       | L0   |
| 202.114.3.0    | 255.255.255.0 | 202.114.2.2  | L0   |
| 0.0.0.0        | 0.0.0.0       | 202.114.2.2  | L0   |

路由表的结构追求对网络拓扑变化的计算最优化.

#### 转发表

转发表由路由表得出，其表项与路由表项有直接对应关系。

转发表格式与路由表格式不同，且其结构追求使查找过程最优化。

表项：目的地址、下一跳MAC地址

默认路由：用于代替所有具有相同“下一跳”MAC地址的项目，从而减少转发表的重复项目。默认路由设置得比其他项目的优先级低。

| 目的站 | 下一跳 |
| :----- | :----- |
| 1      | 直接   |
| 3      | MAC1   |
| 默认   | MAC2   |

分组的实际转发是靠直接查找转发表，而不是直接查找路由表。

## 三、路由算法

### 3.1 静态路由与动态路由

#### 静态路由

由网络管理员手工配置的路由信息，不能及时适应网络状态的变化，适用于简单的小型网络

- 优点：简便、开销较小

#### 动态路由

路由器上的路由表项通过相互连接的路由器之间彼此交换信息，然后按照一定的算法优化得到。这些路由信息会在一定时间内不断更新，以适应不断变化的网络。

- 优点：能改善网络性能并有助于流量控制
- 缺点：算法复杂，会增加网络的负担。

### 3.2 距离-向量路由算法

- 路由选择表：每条路径的目的地（另一个结点）、路径的代价（距离）
- 所有结点定期将它们的整个路由选择表传送给所有与之直接相邻的结点
- 所有结点都监听从其他结点传来的路由选择更新信息，并在以下情况下更新自己的路由选择表
- 更新信息中包含了自己路由表中不存在的路由，新增该路由
- 更新信息中包含一条已有的但距离更短的路由信息，替换该路由
- 网络中结点数越多，更新报文越大
- 可能遇到路由环路等问题
- 最常见的距离-向量路由算法是RIP算法，采用“跳数”作为距离的度量

### 3.3 链路状态路由算法

- 每个结点都具有完全的网络拓扑信息。
- 每个结点检查自己所有直接链路的状态，并将链路状态信息发送给网络中的其他所有结点
- 结点收到链路状态信息后，更新自己的网络拓扑和状态“视野图”，若链路状态发生变化，则结点对更新的网络图利用Dijkstra最短路径算法重新计算路由。
- 特征：
- 向本自治系统中所有路由器发送信息，使用泛洪法，即通过所有端口向所有相邻路由发送信息，收到信息的相邻路由器又将此信息发往其所有相邻路由器（但不再发送给发来信息的那个路由器）
- 发送的信息是路由器的直接链路状态
- 只有当链路状态发生变化时，路由器才向所有路由器发送此信息。
- 优点：
- 每个路由结点使用同样的原始状态数据独立地计算路径，不依赖中间结点地计算
- 链路状态报文仅包含单个结点的直接链路信息，其大小与网络中路由结点数量无关，因此具有更好的规模可伸展性。

### 3.4 层次路由

是OSPF路由协议所采用的，即将一个AS再划分为若干区域，每个路由器知道在本区域内的转发路由，而不必知道其他区域的内部结构。

## 四、路由协议

### 4.1 自治系统

自治系统（AS）是指单一技术管理下的一组路由器。

- 对于AS内部的分组转发，这些路由器使用AS内部的路由选择协议和共同的度量来确定转发路由
- 对于AS之间的分组转发，这些路由器使用AS之间的路由选择协议来确定转发路由

一个自治系统内的所有网络由一个行政单位管辖

一个自治系统的所有路由器必须是连通的

域内路由：AS内部的路由

域外路由：AS之间的路由

### 4.2 内部网关协议 IGP

#### 路由信息协议 RIP

- RIP是内部网关协议中最先得到广泛应用的协议，其最大优点是简单
- RIP规定
- 网络中的每个路由器都要维护从**它自身**到**其他每个目的网络**的距离记录（距离向量）
- 距离/跳数：规定一个路由器到其直接连接网络的距离为1，每经过一个路由器，距离+1
- 优先选择跳数少的路径
- 一条路径最多只能包含15个路由器，当距离为16时，表示网络不可达。因此RIP只适用于小型互联网。最高跳数的设置可以防止数据报不断循环在环路上
- 默认任意两个使用RIP的路由器之间每30秒广播一次RIP路由更新信息，以自动建立并维护路由表
- RIP中每个网络的子网掩码必须相同。但在新的RIP2中，支持变长子网掩码和CIDR。
- RIP特点
- 仅与相邻路由器交换信息
- 交换的信息是当前路由器所知道的全部信息，即自己的路由表
- 按固定的时间间隔交换路由信息
- **RIP是应用层协议**，使用UDP传送数据（端口520）. RIP选择的路径不一定是时间最短的，但一定是具有最少路由器的路径。
- **算法流程（即距离-向量路由算法）**
- 收到来自路由器X的RIP报文，先修改此报文中的所有项目：将“下一跳”字段都修改为X，并将“距离”字段的值+1
- 对于修改后的报文中的每个项目：
  - 本路由表中没有该项目的目的网络N，将该项目添加到本路由表中
  - 本路由表中有该项目的目的网络N，且对应下一跳地址也为X，用收到的项目替换原项目
  - 本路由表中有该项目的目的网络N，但对应下一跳地址不是X，则比较距离大小。若收到的项目距离更小，则用收到的项目替换原项目，否则什么也不做。
- 如果180秒后还没有收到相邻路由器的RIP报文，则把该路由器标记为不可达路由器（即把距离设置为16）
- RIP优点
- 实现简单
- 开销小
- 收敛过程较快
- RIP缺点
- 限制了网络规模，最大距离为15
- 路由器之间交换的是完整路由表，因此网络规模越大，开销越大
- 网络出现故障时，会出现慢收敛现象，即坏消息传得慢，使得更新过程的收敛时间长

#### 开放最短路径优先协议 OSPF

- OSPF是使用分布式链路状态路由算法的典型代表

- OSPF特点

- 向本自治系统中的所有路由器发送信息，使用泛洪法

- 交换的信息是当前路由器所知道的部分信息，即与本路由器相邻的所有路由器的链路状态

- 只有当链路状态发生变化时，路由器才用泛洪法向所有路由器发送此信息，并且更新过程收敛快，不会出现RIP算法中“坏消息传得慢”的问题。

- **OSPF是网络层协议**，不使用UDP或TCP，而直接用IP数据报传送（首部协议字段89）.

- 对不同链路可根据IP分组的不同服务类型设置为不同的代价，从而对不同的业务可计算出不同的路由，灵活性强

- 多路径间的负载平衡：若到同一目的网络有多条相同代价的路径，则将通信量分配给这几条路径

- 分组具有鉴别功能，保证了仅在可信赖的路由器之间交换链路状态信息

- 支持可变长度的子网划分和无分类编址CIDR

- 每个链路状态都带上一个32位的序号，序号越大，状态就越新

- OSPF工作原理

- 所有路由器上都能建立一个链路状态数据库/全网的拓扑结构图

  - 为确保链路状态数据库全网同步，规定每隔一段时间刷新一次数据库的链路状态

- 每个路由器根据这个拓扑结构图，使用Dijkstra最短路径算法计算从自己到各目的网络的最优路径，从而构造自己的路由表

- 为了使OSPF能应用于规模很大的网络，OSPF将一个自治系统划分为若干个更小的“区域”

  - 泛洪法交换链路信息的范围局限在每个“区域”上，从而减少整个网络上的通信量。
  - 一个区域内的路由器只知道自己区域的网络拓扑
  - 区域有层次划分，处于上层的区域称为“主干区域”，负责连通其他下层区域，有时还连接其他自治域

- OSPF分组类型

- 问候分组：用于发现和维持邻站的可达性

  - 每隔10秒，每两个相邻路由器要交换一次问候分组

- 数据库描述分组：向邻站给出自己的链路状态数据库中所有链路状态项目的摘要信息

  - 路由器刚开始工作时，相邻路由器需要用数据库描述分组交换摘要信息，以同步数据库

- 链路状态请求分组：向对方请求发送某些链路状态项目的详细信息

- 链路状态更新分组：用泛洪法对全网更新链路状态

- 链路状态确认分组：对链路更新分组的确认

  ![image-20221121083910004](https://streamazure.github.io/Computer_Basics_Notes/Computer_Network_Notes/0x04%20%E7%BD%91%E7%BB%9C%E5%B1%82/image-20221121083910004.png)

- OSPF优点

- 适用于网络规模很大的情况，没有“坏消息传得慢”的问题

### 4.3 外部网关协议 EGP

#### BGP定义

- 边界网关协议（BGP）是一种外部网关协议，用于不同自治系统的路由器之间交换路由信息。
- 力求找到一条能够到达目的网络且比较好的路由（不能兜圈子），而不是最佳路由
- 采用路径向量路由选择协议，与距离向量协议和链路状态协议有很大区别
- **BGP是应用层协议**，**使用TCP报文传送**

#### BGP要解决的问题

- 自治系统之间路由选择困难
- 对于自治系统之间的路由选择，要寻找最佳路由是很不现实的
- 自治系统之间的路由必须考虑有关策略

#### BGP工作原理

- 自治系统管理员选择一个或多个路由器作为该自治系统的“BGP发言人“
- BGP发言人负责与其他自治系统的BGP发言人交换路由信息
- 交换路由信息时，首先要建立TCP连接
- 在TCP连接上交换BGP报文以建立BGP会话
- 利用BGP会话交换路由信息
- 所有BGP发言人都相互交换网络可达性信息后，即可找出到达各自治系统的较好路由
- BGP发言人既要运行BGP，也要运行自己所属AS所用的内部网关协议

#### BGP特点

- BGP交换路由信息的结点的数量级是自治系统的数量级，比自治系统中的网络数少很多
- 每个自治系统中BGP发言人数量很少，使得路由选择不至于过分复杂
- BGP支持CIDR
- 路由表表项既包含目的网络前缀、下一跳路由器，还要包括到达该目的网络所要经过的各个自治系统序列
- 在BGP刚开始运行时，BGP的邻站交换整个BGP路由表；随后只在发生变化时更新有变化的部分。节省网络带宽和处理开销。

#### BGP报文

- 打开报文：用来与相邻的另一个BGP发言人建立关系
- 更新报文：用来发送某一路由的信息，以及列出要撤销的多条路由
- 保活报文：用来确认打开报文并周期性地证实邻站关系
- 通知报文：用来发送检测到的差错

|                                | **RIP**                                      | **OSPF**                                           | BGP                                  |
| :----------------------------- | :------------------------------------------- | :------------------------------------------------- | :----------------------------------- |
| 类型                           | 内部网关协议                                 | 内部网关协议                                       | 外部网关协议                         |
| 路由算法                       | 距离-向量                                    | 链路状态                                           | 路径-向量                            |
| 路径选择                       | 跳数最少                                     | 代价最低                                           | 较好，非最佳                         |
| **信息交换范围**               | 仅与相邻路由器                               | 洪泛法向全网路由器发送                             | 仅与相邻路由器                       |
| **交换的信息内容**             | 自己的路由表                                 | 与本路由器相邻的链路状态                           | 首次：整个路由表非首次：有变化的部分 |
| **交换时机**                   | 按固定时间间隔交换                           | 仅在链路状态更新时交换                             | /                                    |
| **所在层次**                   | 应用层（端口520），UDP数据报传送             | 网络层，IP数据报传送                               | 应用层，TCP数据报传送                |
| **对变长子网掩码和CIDR的支持** | 不支持，要求每个网络子网掩码都相同           | 支持                                               | 支持CIDR                             |
| **距离的定义**                 | 规定一个路由器到其直接连接网络的距离为1      | 可为不同服务给出不同定义，灵活性强                 | /                                    |
| **优点**                       | 实现简单；开销小                             | 适用于网络规模很大的情况，没有“坏消息传得慢的问题” | /                                    |
| **缺点**                       | “坏消息传得慢”、网络规模有限（最大距离为15） | /                                                  | /                                    |

## 五、IPv4

### 5.1 IPv4分组格式

![image-20221121094132678](https://streamazure.github.io/Computer_Basics_Notes/Computer_Network_Notes/0x04%20%E7%BD%91%E7%BB%9C%E5%B1%82/image-20221121094132678.png)

IPv4的首部分为固定部分和可变部分。

- 固定部分：长度固定，共20B，所有IP分组都具有，因此IPv4的首部至少为20B
- 可变部分：包含一些可选字段，其长度可变

**首部的重要字段**

- 版本：IP协议的版本
- 首部长度：4bit，最多可表示15个单位，而***单位为4B\***。因此该字段可表示的最长首部长度为15×4B=60B，即一个IP数据报的首部至少为20B，至多为60B，且首部长度必须为4B的整数倍
- 总长度：16bit，最多可表示2^16个单位，而***单位为1B\***。指首部和数据之和的长度。因此一个IP数据报的最大长度为65535B。然而，IP数据报交到数据链路层作为以太网帧的数据部分时，由于以太网帧的MTU值为1500B，若一个IP数据报的总长度超出该值，则需要分片封装成多个以太网帧。
- 标识：16bit，是一个计数器，每产生一个数据报就+1，但不是序号。IP数据报分片时，每个分片的标识都相同
- 标志：3bit
- 最低位为MF（More Fragment），MF=1时表示后面还有分片，MF=0时表示最后一个分片
- 中间一位为DF（Don't Fragment），DF=0时才允许分片
- 片偏移：13bit，最多可表示2^13个单位，而***单位为8B\***。指出一个分片在原数据报中的相对位置。
- 这个相对位置不含首部。即记数据部分的开头为相对位置0.
- **每个分片（除最后一个分片外）的数据部分长度一定是8B的整数倍**
- 生存时间（TTL）：8bit，数据报在网络中可通过的路由器的最大值，每通过一个路由器，TTL-1，当TTL被减为0时丢弃该分组，以免分组在网络中永远循环
- 协议：8bit，指出此数据报携带的数据使用何种协议，即应该上交给传输层的哪个协议进行处理。6表示TCP，17表示UDP
- 首部校验和：16bit，只校验数据报的首部，不校验数据部分
- 源地址字段：4B，发送方的IP地址
- 目的地址字段：4B，接收方的IP地址

**必须记住的内容**

首部长度字段的单位是4B

总长度字段的单位是1B

片偏移字段的单位是8B

每个分片（除最后一个分片外）的数据部分长度一定是8B的整数倍

### 5.2 IP数据报的分片与重组

#### 如何分片

IP数据报下发给数据链路层进行封装时，由于数据链路层的各个协议都有MTU限制（如以太网帧为1500字节），可能需要将一个IP数据报分片并封装成多个帧，以符合MTU要求。

- 每个片都是一个IP数据报。
- 每个片都具有与原数据报基本相同的首部（个别字段不同）。

#### 分片计算

例，一个长4000B（首部20B，数据部分3980B）的IP数据报需要转发到一条MTU为1500B的链路上。则：

- 一个分片中可包含20B首部和1480B数据部分，又总数据部分为3980B，所以需要为分为3个分片
- 每个分片的首部标识字段与原数据报的首部标识字段相同
- 第1个分片的MF=1，DF=0，片偏移=0
- 第2个分片的MF=1，DF=0，片偏移为185，即从原数据报的第185×8=1480字节开始，因为第1个分片已包含了数据部分的前1480字节。
- 第3个分片的MF=0，DF=0，片偏移为370，即从原数据报的第2960字节开始。

#### 重组

- 分片在目的主机的网络层被重新组装
- 目的主机检查数据报的标识号，具有同一标识号的数据报即属于同一个原始数据报的分片。然后根据片偏移字段确定分片的先后顺序。

#### 不需要分片的情况

广域网中的分组不必分片。

因为广域网所能通过的分组最大长度是广域网中的所有结点都事先知道的，源结点不会发送网络不支持的过长分组。

### 5.3 IPv4地址与NAT

#### IPv4地址

IP地址分为网络号和主机号两部分

- 网络号：标识主机或路由器所连接的网络，在整个因特网范围内唯一
- 主机号：标识主机或路由器，必须在所属网络中唯一

特殊用途的IP地址：

- 主机号全0：表示本网络本身
- 主机号全1：表示本网络的广播地址
- 127.x.x.x：保留为环回自检地址，表示任意主机本身。以此类IP地址位目的地址的IP数据报永远不会出现在任何网络上（只会占用A类地址的网络号）
- 32位全0（0.0.0.0）：表示本网络上的本主机（只会占用A类地址的网络号）
- 32位全1（255.255.255.255）：表示整个TCP/IP网络的广播地址，由于存在路由器对广播域的隔离，一般等效位本网络的广播地址（只会占用E类地址的网络号）

IP地址特点：

- 是分等级的地址结构，由网络号和主机号两部分组成
- IP地址管理机构在分配IP地址时只分配网络号，而主机号则由对应单位自行分配，方便管理
- 路由器仅根据目的主机所连接的网络号来转发分组，减小了路由表所占存储空间
- IP地址是标识一台主机和一条链路的接口。当一台主机同时连接到两个网络时，该主机必须同时具有两个相应的IP地址。因此路由器都至少有两个IP地址
- 用转发器或桥接器连接的若干LAN仍然是同一个网络
- 所有分配到网络号的网络（无论是LAN还是WAN）都是平等的
- 在同一个局域网上的主机或路由器的IP中的网络号必须相同。

IP地址分类：

![image-20221121102316053](https://streamazure.github.io/Computer_Basics_Notes/Computer_Network_Notes/0x04%20%E7%BD%91%E7%BB%9C%E5%B1%82/image-20221121102316053.png)

| 网络类别 | 最大可用网络数 | 第一个可用网络号 | 最后一个可用网络号 | 一个网络中的最大主机数 |
| :------- | :------------- | :--------------- | :----------------- | :--------------------- |
| A        | $2^7-2$        | 0                | 126                | $2^{24}-2$             |
| B        | $2^{14}$       | 128.0            | 191.255            | $2^{16}-2$             |
| C        | $2^{21}$       | 192.0.0          | 223.255.255        | $2^8-2$                |

#### 网络地址转换 NAT

- 作用：将专用网络地址转换为公用地址，从而对外隐藏内部管理的IP地址。
- 好处
- 整个专用网络只需要一个全球IP地址就可以与因特网连通。
- 隐藏了内部网络结构，降低了内部网络收到攻击的风险
- 私有IP地址/可重用地址
- 只用于LAN，不用于WAN
- 必须通过NAT转换成公用地址后才能用于因特网的地址。
- 路由器收到目的地址为私有地址的数据报时，一律不进行转发。
- 网段：
  - 1个A类网段，即**10**.0.0.0~**10**.255.255.255
  - 16个B类网段，即**172.16**.0.0~**172.31**.255.255
  - 256个C类网段，即**192.168.0.**0~**192.168.255**.255
- NAT转换表
- 表项：{本地IP地址:端口} {全球IP地址:端口}
- 多个私有IP地址可以映射到同一个全球IP地址

![image-20221121112342753](https://streamazure.github.io/Computer_Basics_Notes/Computer_Network_Notes/0x04%20%E7%BD%91%E7%BB%9C%E5%B1%82/image-20221121112342753.png)

- 普通路由器转发IP数据报时，不改变其源IP地址和目的IP地址，仅工作在网络层

NAT路由器转发IP数据报时，一定要更换其IP地址（转换源IP地址或目的IP地址），还需要查看和转换端口号（传输层）

### 5.4 子网划分、子网掩码、CIDR

#### 子网划分

- 子网划分是一个单位内部的事情，对外表现为没有划分子网的网络
- 子网号占用了原本两级结构中主机号的一部分
- 划分子网后的IP地址，其网络号不改变
- 分类地址中，子网号不能为全1或全0；CIDR中，子网号可以为全1或全0

#### 子网掩码

若使用子网掩码，则

1. 一台主机在设置IP地址信息时，必须设置子网掩码
2. 同属于一个子网的所有主机及路由器的相应端口，必须设置相同的子网掩码
3. 路由器的路由表中，所包含信息的主要内容有目的网络地址、子网掩码、下一跳地址

#### 无分类编址CIDR

采用CIDR时，IP地址的记法为：IP地址/网络前缀所占比特数。如128.14.32.5/20，表示IP地址前20位是网络前缀，后12位是主机号

CIDR没有在32位地址中指明若干位作为子网字段，但单位内部仍可按照需要划分子网。如对地址块/20，可再从主机号中借用3位，从而划分出8个子网，此时单位内部的IP地址为IP地址/23

CIDR地址块：

- 网络前缀都相同的连续IP地址组成CIDR地址块
- 一个CIDR地址块可以表示很多地址，称为路由聚合/构成超网
- 有利于减少路由器之间的信息交换，提高网络性能
- 地址数一定是2的整数次幂，实际可指派地址为$2^N-2$，主机号全0和全1的地址都不使用

CIDR优点：

- 网络前缀长度灵活。上层网络前缀长度较短，路由表项目少；网络内部又可自行延长网络前缀划分子网

最长前缀匹配（最佳匹配）：

- 使用CIDR时，路由表的每个项目构成：网络前缀+下一跳地址，可能不止一个结果
- 从匹配结果中选择具有最长网络前缀的路由
- 最常用的数据结构：二叉线索

#### 计算技巧

192 = 1100 0000

168 = 1010 1000

96 = 0110 0000

240 = 1111 0000

224 = 1110 0000

### 5.5 网络层转发分组

#### 转发表

分组转发是基于目的主机所在网络的。

转发表必包含两条信息：目的网络-下一跳地址

特殊路由：

- 主机路由：对特定目的主机的IP地址专门指明一个路由，以便控制和测试网络。如a.b.c.d/32
- 默认路由：用特殊前缀0.0.0.0/0表示默认路由，只要目的网络是不在转发表中的其他网络，一律选择默认路由

#### 分组转发算法

1. 从收到的IP数据报的首部提取目的主机的IP地址D
2. 若查找到特定主机路由，则按照这条路由的下一跳转发，否则按前缀长度从长到短的顺序开始检查
3. 对于检查到的每一条路由信息，将路由信息的子网掩码与D进行与运算，若所得结果与路由信息的前缀匹配，则查找结束，按照下一跳转发；否则继续检查下一条路由信息
4. 全部检查完毕仍未转发，此时若还存在默认路由，则按默认路由转发；如果没有默认路由，报告转发分组出错

在IP数据报的转发过程中，会修改其MAC帧首部的MAC地址信息。在不同网络中传送时，MAC帧中的源地址和目的地址会变化；而网桥转发帧时，不改变帧的源地址

### 5.6 ARP、DHCP、ICMP

#### IP地址与硬件地址

为什么不直接使用硬件地址进行分组转发：

- 由于路由器的隔离，IP网络中无法通过广播MAC地址来完成跨网络的寻址
- 通过路由器转发分组时，IP分组在每个网络中都由路由器拆封和重新封装，其MAC帧首部的源地址和目的地址会不断改变，这决定了无法使用MAC地址跨网络通信
- 互联在一起的网络的硬件地址体系各不相同，而在IP层抽象的互联网中能够使用统一的、抽象的IP地址研究通信

#### 地址解析协议 ARP

- 负责IP地址到MAC地址的映射。工作在网络层.
- ARP表：存放本局域网上各主机和路由器的IP地址到MAC地址的映射表
- 每台主机都设有一个ARP高速缓存，用于存储ARP表
- ARP的工作原理
- 主机A准备向本局域网内的主机B发送IP数据报。A首先查找自己的ARP高速缓存，看有无主机B的IP地址。
- 若有，则查出主机B对应硬件地址，写入MAC帧的目的地址并发送；若没有，则将FF-FF-FF-FF-FF-FF写入MAC帧的目的地址，并广播ARP请求分组，使局域网内所有主机都收到此ARP请求
- 主机B收到ARP请求后，向主机A（而不是广播）发送ARP响应分组，分组中包含主机B的IP与MAC地址的映射关系
- 主机A收到ARP响应分组后，将映射写入自己的ARP缓存，然后按照查询到的硬件地址发送MAC帧

若需要向其他局域网的主机发送IP数据报，则要查找的硬件地址为本局域网路由器的硬件地址。

#### 动态主机配置协议（DHCP）

- 给主机动态分配IP地址。允许一台计算机加入新的网络和获取IP地址而不用手工参与
- 应用层协议，基于UDP，以客户端/服务器模式工作
- 服务器端口67，客户端端口68
- 工作原理：
- 客户机广播”DHCP DISCOVER“消息，寻找网络中的DHCP服务器。该消息源地址为0.0.0.0，目的地址为255.255.255.255
- 服务器收到消息，广播”DHCP提供“消息，其中包含提供给客户机的IP地址。该消息源地址为服务器地址，目的地址为255.255.255.255
- 客户机收到消息，若接受该IP地址，则广播”DHCP请求“消息。该消息源地址为0.0.0.0，目的地址为255.255.255.255
- 服务器广播”DHCP确认“消息，将该IP地址分配给客户机。该消息源地址为服务器地址，目的地址为255.255.255.255
- DHCP分配的IP地址是临时的，存在时间限制，即租用期。租用期由服务器决定，客户机也可在报文中提出要求
- 客户机与服务器之间需要通过广播方式进行交互，因为客户机尚未有IP地址

#### 网际控制报文协议（ICMP）

- IP层协议
- ICMP差错报文：目标主机或到目标主机路径上的路由器向源主机报告差错和异常情况
- 终点不可达：路由器或主机不能交付数据报
- 源点抑制：路由器或主机由于拥塞而丢弃数据报时，发送抑制报文使源点放慢发送速率
- 超时：路由器收到TTL=0的数据报时向源点发送该报文，或终点没有在预先规定的时间内收到一个数据报的全部分片时发送该报文，并丢弃已收的分片
- 参数问题：路由器或目的主机收到的数据报首部存在不正确的字段
- 改变路由（重定向）：路由器发给源主机，让源主机知道下次应该将报文发给另外的路由器
- 不应发送ICMP差错报文的情况：
- ICMP差错报文发送过程出错，不再发送差错报文
- 对具有组播地址的数据报都不发送差错报文
- 对具有特殊地址（如127.0.0.0或0.0.0.0）的数据报不发送差错报文
- ICMP询问报文
- 回送（echo）请求和回答报文
- 时间戳请求和回答报文
- 地址掩码请求和回答报文
- 路由器询问和通告报文
- ICMP两个最常见的应用
- Ping
  - 使用ICMP回送请求和回答报文
  - 工作在应用层，但直接使用网络层的ICMP，不适用TCP或UDP
- Traceroute/Tracert
  - 使用ICMP超时报文
  - 工作在网络层

## 六、IPv6

### 6.1 IPv6特点

#### 主要特点

- 更大的地址空间，128位地址
- 扩展的地址层次结构
- 灵活的首部格式
- 改进的选项
- 允许协议继续扩充
- 支持即插即用（即自动配置）
- 支持资源预分配
- IPv6只有在包的源结点才能分片，在传输路径的路由器上不能再分片。所以从一般意义上说，IPv6不允许分片
- **取消了校验和字段**
- **IPv6首部长度必须是8B的整数倍，而IPv4首部是4B的整数倍**
- 增大了安全性。身份验证和保密功能是IPv6的关键特征

#### 相对于IPv4的改进

- 大大扩充了地址空间
- 简化了IP数据报首部，包含8个域。使路由器能够更快地处理分组，从而可以改善吞吐率
- 更好地支持选项。一些之前必要的字段现在变成了可选字段，此外，表示选项的方式的改变还能加快分组的处理速度。

### 6.2 IPv6数据报

#### 目的地址类型

- 单播：即传统的点对点通信
- 多播：一点对多点的通信
- 任播：IPv6新增的类型，目的站是一组计算机，但数据报在交付时只交付其中的一台计算机，通常是距离最近的计算机

#### 地址表示法

地址中的每4位用一个十六进制数表示，并用冒号分隔每16位。

紧凑处理：

- 当一个16位域中的开头存在一些连续的0时，直接省略不写；若整个16位域都是0，则用一个0来表示
- 有相邻的0值域时，还可以用双冒号缩写，如4BF5:0000:0000:0000:BA5F:xxxxxx可缩写为4BF5::BA5F:xxxxxx

由于双冒号代替的是不定个数的0值域，为了能够从总值域数推算被省略的0值域的个数，双冒号在IP地址中只能出现一次

#### 分级概念扩展

使用三个等级，以便路由器能够更快地查找路由

- 第一级（顶级）：指明全球都知道的公共拓扑
- 第二级（场点级）：指明单个场点
- 第三级：指明单个网络接口

#### 兼容与过渡

- IPv6系统必须能够接受和转发IPv4数据报，并且能够为IPv4数据报选择路由
- 双协议栈：在一台设备上同时装有IPv4和IPv6协议栈。若这台设备是计算机，则该计算机既有IPv4地址，又有IPv6地址，并具备同时处理这两个协议地址的功能。若该台设备是路由器，则可能分别连接了IPv4网络和IPv6网络
- 隧道技术：将整个IPv6数据报封装到IPv4数据报的数据部分，从而使得IPv6数据报可以在IPv4网络的隧道中传输

## 七、IP组播

### 7.1 组播的概念

- 组播：发送方把单个分组发送给一个组播地址，该组播地址标识一组地址。而后由网络负责把这个分组的副本（仅在传送路径出现分岔时复制）投递给该组中的每一台主机。一台主机可以同时属于多个组。
- 主机如何加入组播组：使用IGMP协议，通知本地网络上的路由器。
- 硬件支持：能够运行组播协议的路由器。
- 组播一定仅应用于UDP，不可能用TCP。
- 组播的应用：视频点播、视频会议等，发送方需要将一个分组发送给多个目的主机的场合
- 以多个单播仿真组播的缺陷：引起主机上大量的处理开销和增大网络负载

### 7.2 IP组播地址

- D类地址格式。前四位为1110，范围224.0.0.0~239.255.255.255，每个D类地址标识一个组播组。
- 组播数据报
- 使用D类地址作为目的地址，且协议字段为2，表示使用IGMP
- 尽最大努力交付，不提供可靠交付
- 组播地址只用于目的地址，不能用于源地址
- 不产生ICMP报文。Ping一个组播地址不会有响应。
- 不是所有的D类地址都是组播地址
- 硬件组播
- 在因特网上进行组播的最后阶段，还是要把组播数据包在局域网上通过硬件组播交付给组播组的所有成员
- 以太网组播地址的范围：01-00-5E-00-00-00 到 01-00-5E-7F-FF-FF，即前9位固定，只有后23位用于组播。而D类IP地址中前4位固定，有28位可用于组播。由于以太网组播地址中的后23位与D类IP地址的后23位有对应关系，D类IP地址中有5位不参与映射。不参与映射的位，无论值如何，在映射时都视为0处理。
- 例如，IP地址224.215.145.230，其中215=1101 0111，最高位即从右往左第24位，是不参与映射的位，视为0处理，故这一个字节对应的MAC地址字段应为57H，完整MAC地址位01-00-5E-57-91-E6

![image-20221124102328634](https://streamazure.github.io/Computer_Basics_Notes/Computer_Network_Notes/0x04%20%E7%BD%91%E7%BB%9C%E5%B1%82/image-20221124102328634.png)

- 两个不同的IP组播地址可能会转换成同一个以太网硬件组播地址。收到组播数据报的主机，还要在IP层利用软件进行过滤

### 7.3 IGMP与组播路由算法

- IGMP是网际协议IP的一个组成部分
- IGMP不是在因特网范围内对所有组播组成员进行管理的协议。IGMP不知道组播组包含成员数，也不知道成员分布在哪些网络上，IGMP仅让本地局域网的组播路由器知道本局域网上是否有主机参加或退出了某个组播组
- 工作流程
- 第一阶段：某台主机要加入新的组播组，该主机向组播组的地址发送一个IGMP报文，声明自己要成为该组成员。本地局域网的组播路由器首先收到该报文，再将组成员关系转发给因特网上其他组播路由器
- 第二阶段：本地组播路由器需要周期性询问局域网内主机，以确定这些主机是否仍是某个组的成员。如果对于某个组，在经过几次探询后仍未有主机响应，则不再将该组的成员关系转发给其他组播路由器
- 组播路由算法
- 实际上是要找出**以源主机为根结点的组播转发树**，从而每个分组在每条链路上只传送一次。
- 不同的多播组对应不同的多播转发树
- 同一个多播组，对不同的源点也会有不同的多播转发树
- 主要实现：基于链路状态的路由选择、基于距离-向量的路由选择、可以建立在任何路由器协议之上的协议无关的组播（PIM）

### 7.4 广播帧与组播帧的过滤区别

主机可能会收到目的地不是自己的广播帧或组播帧，需要对这些帧进行识别并丢弃。但处理部件是不同的。

广播帧：通过网卡NIC接收广播帧，然后网卡将帧传递给操作系统。CPU执行协议软件，来界定是否接收或处理该广播帧

组播帧：由网卡直接界定是否接收或处理该组播帧，不由CPU处理。CPU仅对网卡进行相关配置。

## 八、移动IP

### 8.1 移动IP基本概念

- 移动结点：把其连接点从一个网络或子网改变到另一个网络或子网的主机
- 移动IP：移动结点以固定的网络IP地址实现跨越不同网段的漫游功能，并保证基于网络IP的网络权限在漫游过程中不发生任何改变
- 本地代理：在一个网络环境中，一个移动结点的永久居所称为归属网络，归属网络中代表移动结点执行移动管理功能的实体称为归属代理/本地代理。本地代理根据移动用户的转交地址，采用隧道技术转交移动结点的数据报
- 外部代理：在外部网络中帮助移动结点完成移动管理功能的实体称为外部代理
- 移动IP与移动自组网络的区别
- 移动IP使漫游主机以多种方式连接到因特网，网络功能仍基于固定互联网中使用的各种路由选择协议
- 移动自组网络是将移动性扩展到无线领域中的自治系统，有自己独特的路由选择协议，可以不和因特网连接
- 移动IP和动态IP是完全不同的两个概念

### 8.2 移动IP通信过程

- 每个移动结点具有唯一的本地地址，在移动过程中本地地址不变。本地网络上有一个本地代理维护移动结点当前的位置信息
- 当移动结点连接到外地网络上时，以转交地址标识移动结点当前所处位置，以便进行路由选择。
- 移动绑定/绑定：移动结点的本地地址与当前转交地址的联合
- 移动结点得到一个新的转交地址后，通过绑定向本地代理进行注册。
- 基本通信流程：
- 移动结点在本地网络时，按传统方式进行通信
- 移动结点漫游到外地网络时，仍用本地地址进行通信，但需要向本地代理注册当前的转交地址，以便收到转发给它的IP分组
- 本地代理收到注册后，会构建一条通向转交地址的隧道，将截获的发给移动结点的IP分组通过隧道送至转交地址（外部代理）
- 在转交地址处解封，最后送到移动结点
- 位于外地网络的移动结点发送数据报，需要通过外网的路由器或外部代理
- 移动结点更换外地网络时，只需要向本地代理更新转交地址
- 移动结点回到本地网络时，向本地代理注销转交地址
- 在移动IP中，一个移动结点具有两个IP地址，即本地地址和转交地址。本地地址是始终不变的，而转交地址根据移动结点所在的外网改变

# chap5 传输层

## 一、传输层概述

### 1.1 传输层功能

传输层是面向通信部分的最高层，也是用户功能中的最低层。

- 传输层为运行在不同主机上的进程之间提供逻辑通信/端对端通信。
- 复用与分用（不是传输层特有的，网络层也有）
- 复用：发送方不同的应用进程可使用同一个传输层协议传送数据
- 分用：接收方的传输层在剥去报文首部后能够把这些数据正确交付到目的应用进程
- 对首部和数据部分进行差错检测。
- 提供两种不同的传输协议，即面向连接的TCP和无连接的UDP

### 1.2 传输层的寻址与端口

#### 端口

端口是传输层服务访问点（SAP），标识主机中的应用进程。

对应地，网络层SAP是IP地址，标识主机；数据链路层SAP是MAC地址，标识主机。

传输层的端口是软件端口，而不是硬件端口。

#### 端口号

端口号长度为16bit，能表示65536个不同的端口号。

端口分类：

- 服务器端端口号

- 熟知端口号，0~1023。

  | 应用程序   | FTP  | TELNET | SMTP | DNS  | TFTP | HTTP | SNMP |
  | :--------- | :--- | :----- | :--- | :--- | :--- | :--- | :--- |
  | 熟知端口号 | 21   | 23     | 25   | 53   | 69   | 80   | 161  |

- 登记端口号，1024~49151.

  供没有熟知端口号的应用程序使用，使用此类端口号必须在IANA登记，以防重复

- 客户端端口号

- 49152~65535

- 仅在客户进程运行时才动态选择，又称为临时端口。通信结束后端口号可供其他客户进程继续使用。

#### 套接字

套接字唯一地标识网络中的一台主机和其上的一个进程，即（IP地址:端口号）

### 1.3 无连接服务与面向连接服务

无连接服务：两个实体之间的通信不需要预先建立连接，通信时，直接将信息发送到网络上，由网络尽力而为地向目的地传送

面向连接服务：两个实体之间地通信需要预先建立连接，通信时，整个连接的情况被实时监控和管理。通信结束后需要释放连接。

**TCP**

- 提供面向连接服务
- 提供可靠传输服务，以增大分组首部长度及处理开销为代价。
- 不提供广播或组播服务，是点对点的
- 适用场合：文件传输协议（FTP）、超文本传输协议（HTTP）、远程登录（TELNET）

**UDP**

- 提供无连接、不可靠服务
- 仅在IP之上附加了两个服务：多路复用和对数据的错误检查
- 接收方不需要对UDP报文给出确认
- 简单、执行速度快、实时性好
- 使用场合：小文件传输协议（TFTP）、DNS、SNMP、实时传输协议（RTP）

**TCP和网络层虚电路的区别**

- TCP报文在传输层抽象的逻辑信道中传输，对路由器不可见
- 虚电路经过的交换结点都必须保存虚电路状态信息
- 若网络层采用虚电路方式，则无法提供无连接服务；而传输层采用TCP不影响网络层提供无连接服务。

## 二、UDP

### 2.1 UDP特点

- **无连接**，也不需要维护连接状态，能支持更多的活动客户机
- **尽最大努力交付**，不保证可靠交付
- **面向报文**：不合并不拆分，对于应用层交下来的报文，只添加首部就下交给网络层。报文是UDP数据报处理的最小单位。
- **无拥塞控制**：适用于一些要求以稳定速度发送、能容忍一些数据丢失但不允许有较大时延的应用
- **首部开销小**：TCP有20B的首部开销，UDP仅有8B开销
- **支持一对一、一对多、多对一、多对多通信**
- 常用于一次性传输较少数据的网络应用、多媒体应用

### 2.2 UDP首部格式

首部长度固定8B，由4个字段构成，每个字段占2B

- 源端口：源端口号。在需要对方回应时选用，不需要时可以为全0
- 目的端口：目的端口号。在终点交付报文时必须使用
- 长度：UDP数据报的长度（包括首部和数据），其最小值是8（即仅有首部而无数据时）
- 校验和：检测UDP数据报在传输中是否有错，有错则丢弃。是可选字段，若源主机不想计算校验和，可以为全0.

若接收方发现报文目的端口号不正确，则丢弃该报文，并通过ICMP发送“端口不可达”差错报文给发送方。

### 2.3 UDP校验

#### 伪首部

在计算校验和时，要在UDP数据报前增加12B的伪首部参与计算。伪首部仅用于计算校验和，不向上递交也不会向下传送。

伪首部内容包括：

- 源IP地址（4B）
- 目的IP地址（4B）
- 固定值为0的字段（1B）
- 固定值为17的字段（1B）
- UDP长度（2B）

由于伪首部参加了校验和的计算，故UDP校验还可以检查IP数据报的源IP地址和目的IP地址。

#### 发送方计算过程

UDP校验既检查首部也检查数据部分。

1. 发送方将校验和字段置为全0，并添加伪首部
2. 将添加伪首部后的UDP数据报每16位划分一段，若不能被划分为整数个段（即数据报长度为奇数个字节），则在数据部分的末尾填入1个全0字节（仅用于校验和计算，不会实际发送出去）。
3. 按二进制反码计算出这些16位字的和，将此和的二进制反码写入校验和字段
4. 去掉伪首部和数据部分末尾填充的全0字节，发送。

![image-20221124142954606](https://streamazure.github.io/Computer_Basics_Notes/Computer_Network_Notes/0x05%20%E4%BC%A0%E8%BE%93%E5%B1%82/image-20221124142954606.png)

#### 接收方校验过程

1. 接收方将收到的UDP数据报添加伪首部
2. 将添加伪首部后的UDP数据报每16位划分一段，若不能被划分为整数个段，则在数据部分的末尾填入1个全0字节。
3. 按二进制反码求这些16位字的和。
4. 若无差错，和应该为全1，否则表明有差错，应该丢弃。

#### 效果

校错能力不强，但是简单、处理速度快。

## 三、TCP

### 3.1 TCP特点

- **面向连接**。TCP连接是一条逻辑连接，每条TCP连接只能有两个端点，是端对端的（进程对进程）。
- **可靠传输**。TCP能保证传送的数据无差错、不丢失、不重复且有序
- **全双工通信**。允许通信双方的应用进程在任何时候都能发送数据，为此TCP连接的两端都设有发送缓存和接收缓存，用于临时存放双向通信的数据。
- 发送缓存暂时存放：①应用程序给TCP准备发送的数据；②TCP已发送但尚未收到确认的数据
- 接受缓存暂时存放：①按序到达但尚未被接收应用程序读取的数据；②不按序到达的数据
- **面向字节流**。TCP仅把应用程序交下来的数据视为一串无结构的字节流。
- **报文长度**：根据接收方给出的窗口值和当前网络拥塞程度来决定。如果应用进程传送到TCP缓存的数据块太长，则TCP会划分为合适的长度；若数据块太短，则TCP可以等到积累足够多的字节后再构成报文段发送。

### 3.2 TCP报文段与首部格式

TCP传送的数据单元称为报文段。报文段既可以用来运载数据，又可以用来建立连接、释放连接、应答。

TCP首部有固定20B，另有4NB的可选字段。TCB首部的总长度为4B的整数倍。

![image-20221124150729474](https://streamazure.github.io/Computer_Basics_Notes/Computer_Network_Notes/0x05%20%E4%BC%A0%E8%BE%93%E5%B1%82/image-20221124150729474.png)

- 源端口和目的端口：各占2B。
- 序号：占4B，共2^32个序号。TCP需要给字节流中的每个字节编号，而序号字段的值用于标识本报文段所发送的数据的第一个字节的序号。

如，一个报文段的序号字段值为301，共携带100B数据，则下一个报文段的序号字段值应为401

- 确认号：占4B，标识期望收到的对方下一个报文段的序号值。若确认号为N，则表明到序号N-1为止的所有数据都已正确收到，希望收到序号为N的报文段。
- 数据偏移（即首部长度）：占4bit。单位为4B。因此报文段首部最大长度为60B。“偏移”是指数据部分距离报文段的起始偏移了多少个单位。
- 保留：6bit，保留为以后使用，一般置为全0
- 紧急位URG：URG=1时，表示紧急指针字段有效。表示该报文段有紧急数据需要尽快传送。与紧急指针字段配合使用。
- 确认位ACK：仅当ACK=1时确认号字段有效。TCP规定，在连接建立后所有传送的报文段都必须把ACK置为1.
- 推送位PSH：PSH=1时，表明报文段需要尽快交付给应用进程，而不再等到整个缓存满了再交付。
- 复位位RST：RST=1时，表明TCP连接出现严重差错，必须释放连接，然后再重新建立连接
- 同步位SYN：SYN=1时，表明这是一个连接请求或连接接受报文，与ACK字段配合使用。

SYN=1，ACK=0：这是一个连接请求报文

SYN=1，ACK=1，这是一个连接接受报文

- 终止位FIN：用于释放一个连接。FIN=1时表明该报文段的发送方请求释放连接。
- 窗口：占2B，范围为0~2^16-1（65535）。接收方使用，用于告知发送方自己还有多少字节的接受缓存空间。
- 校验和：占2B。校验包括首部和数据。计算校验和方式与UDP基本一致，**只有伪首部的协议字段要改为6**.
- 紧急指针：占2B。仅在URG=1时才有意义，指出本报文段中紧急数据共有多少字节。由于紧急数据总是位于报文段数据的最前面，因此紧急指针可以直接指出紧急数据的范围。
- 选项：长度可变。最初只规定了一种选项：MSS（最大报文段长度），用于标识报文段中数据字段的最大长度。
- 填充：用于保证TCP首部长度是4B的整数倍。

### 3.2 TCP连接管理

TCP连接的三个阶段：连接建立、数据传送、连接释放

TCP连接建立要解决的问题：

1. 要使每一方能够确知对方的存在
2. 要允许双方协商一些参数（如最大窗口值、是否使用窗口扩大选项、时间戳选项及服务质量等）
3. 能够对运输实体资源（如缓存大小、连接表中的项目等）进行分配

**TCP连接唯一地由通信的两个套接字确定**

- 如果在已经建立的TCP连接的两个端口上再试图建立一条TCP连接，则会**建立失败，不影响之前的TCP连接**

TCP连接的建立采用客户/服务器模式。主动发起连接建立的应用进程称为客户；被动等待连接建立的应用进程称为服务器。

#### TCP连接的建立

通常称为三次握手。

1. 连接建立前，服务器处于LISTEN状态
2. 第一次握手：客户机向服务器发送连接请求报文段。该报文段SYN=1，并选择一个初始序号seq=x。规定该SYN报文段不能携带数据，但消耗一个序号。

客户进入SYN-SENT状态

1. 第二次握手：服务器收到连接请求报文段，若同意建立连接，则发回连接确认报文段，并为该TCP连接分配缓存和变量。该报文段中SYN=1，ACK=1，确认号ack = x+1，同时也为自己选择一个初始序号seq=y。规定该SYN报文段不能携带数据，但消耗一个序号。

服务器进入SYN-RCVD状态

1. 第三次握手：客户机收到连接确认报文段，再发回确认报文段，并为该TCP连接分配缓存和变量。该报文段中ACN=1，确认号ack = y+1，序号seq=x+1。该报文段可以携带数据，若不携带数据则不消耗序号。

客户端进入ESTABLISHED状态

1. TCP连接建立完成。

![image-20221124162654112](https://streamazure.github.io/Computer_Basics_Notes/Computer_Network_Notes/0x05%20%E4%BC%A0%E8%BE%93%E5%B1%82/image-20221124162654112.png)

#### TCP连接的释放

通常称为四次挥手。通信的任意一方都可以主动发起关闭连接请求。

1. 若客户机打算关闭连接，向服务器发送连接释放报文段，并停止发送数据，主动关闭TCP连接。该报文段FIN=1，序号seq=u，不携带数据但消耗一个序号。

客户机进入WAIT-1状态。此时服务器仍能向客户机发送数据。

1. 服务器收到连接释放报文段后，发回确认。ACK=1，确认号ack=u+1，序号seq=v

服务器进入CLOSE-WAIT状态。此时释放了客户机→服务器方向的TCP连接，而服务器→客户机方向的TCP连接仍处于半关闭状态。此时服务器仍能向客户机发送数据。

1. 服务器已无数据需要发送，发出连接释放报文段，FIN=1，ACK=1。设该报文段的序号为w，还需重复上次已发送的确认号ack=u+1。

服务器进入LAST-ACK状态。

1. 客户机收到连接释放报文段，发回确认。ACK=1，确认号ack=w+1，序号seq=u+1。

此时TCP连接还未释放，必须等待2MSL（最长报文段寿命）后，客户机才进入CLOSED状态。

#### 总结

- 连接建立
- SYN=1，seq=x
- SYN=1，ACK=1，seq=y，ack=x+1
- ACK=1，seq=x+1，ack=y+1
- 连接释放
- FIN=1，seq=u
- ACK=1，seq=v，ack=u+1
- FIN=1，ACK=1，seq=w，ack=u+1
- ACK=1，seq=u+1，ack=w+1
- 除了首次发送外，其他报文段的ACK=1
- 确认报文的确认号ack应与要响应的报文的序号对应，所以总是将要响应的报文的序号+1作为确认报文的确认号
- 连接释放过程中，第二次挥手由服务器进行，报文序号为n，第三次也由服务器进行，但报文序号不一定为n+1，可以是n+5，n+100等等，因为第二次挥手和第三次挥手之间服务器可能还发送了一些数据，消耗了序号。

### 3.3 TCP可靠传输

TCP需要保证数据无差错、无丢失、不重复、有序到达。

为保证无差错，TCP采用了与UDP相同的校验机制。而无丢失、不重复和有序则是使用序号、确认、重传等机制实现的。

#### 序号

TCP将应用层交付的数据视为字节流，并为字节流中的每一个字节编号。

TCP报文段首部中的序号字段的值，是指本报文段所发送数据的第一个字节的序号。

#### 确认

TCP报文段首部中的确认号字段的值，是指期望收到的对方的下一个报文段的数据的第一个字节的序号。

TCP默认使用累积确认，只确认数据流中至第一个丢失字节为止的字节。如接收方B收到了A发送的包含字节0~2及字节6~7的报文段，而未能收到字节3~5的报文段，则B发送的确认报文段中的确认号应为3.

TCP并非对发送的每个字节都要进行一次确认，而是对报文段进行确认，所以**TCP采用的是对报文段确认的机制**

#### 重传

两种情况会触发重传：超时、冗余ACK

- 超时
- 对每一个发送的报文段设置一个计时器（重传时间）。若计时器到期而还未收到确认，则自动重传该报文段。
- 重传时间是动态变化的。算法如下：
  1. 初始时已知平均RTT值为$RTT$，并设置权重值α
  2. 经过一次发送-收到确认报文后，往返时间为t1，则$RTT_1=(1-\alpha)RTT+\alpha t_1$
  3. 以此类推。
- 冗余ACK
- 设想以下情况：接收方收到了包含字节1的报文段，并发回确认号2的确认报文段。然而，由于包含字节2~4的报文段在传输过程中丢失，而包含字节5~7的报文段顺利到达了，则接收方再重发确认号2的确认报文段，导致冗余ACK的出现
- 冗余ACK让发送方知道，包含字节2~4的报文段丢失，需要重传。此时发送方可以立即执行重传，这种技术称为**“快速重传”**。

### 3.4 TCP流量控制

为了使发送方速率和接收方读取速率相匹配，需要由接收方根据自己接收缓存的大小，来动态调整发送方的发送窗口大小，实现流量控制。

#### 接收窗口、拥塞窗口、发送窗口

**接受窗口rwnd**：不是接收方的窗口，而是对发送方发送窗口大小的一个限制值。这个值是根据接收方缓存大小确定的，并通过TCP报文段首部中的“窗口”字段告知发送方。单位为字节。

**拥塞窗口cwnd**：也是对发送方发送窗口大小的一个限制值。这个值是发送方根据网络带宽和时延自己确定的，单位为字节。

**发送方的发送窗口 = min{rwnd，cwnd}**

#### 通信过程中rwnd的动态调整过程

假设通信中数据仅由A发往B，B仅发回确认报文。

B发回的确认报文的“窗口”字段需要与“确认号”字段结合理解。如ack=201，rwnd=300，即告知A可以发送序号201到序号500的这300个字节。

![image-20221124172926846](https://streamazure.github.io/Computer_Basics_Notes/Computer_Network_Notes/0x05%20%E4%BC%A0%E8%BE%93%E5%B1%82/image-20221124172926846.png)

#### 与数据链路层流量控制的区别

- 传输层定义端到端用户之间的流量控制，数据链路层定义两个中间的相邻结点的流量控制
- 传输层的窗口大小可以动态变化，而数据链路层的窗口大小固定。

### 3.5 TCP拥塞控制

拥塞控制防止过多数据注入网络，避免网络中的路由器或链路过载。

在讨论拥塞控制时，总是假设接收方有足够大的缓存空间，即发送窗口大小可以直接视为拥塞窗口cwnd大小。

#### 慢开始

- cwnd从一个很小的初始值开始，快速增长（指数型）到给定的阈值**ssthresh**（慢开始门限）

- cwnd初始值的设定

- 如果题目给出了MSS，如MSS=1KB，则拥塞窗口的初始大小就是1KB。

- 【2017真题】若甲向乙发起一个TCP连接，最大段长MSS=1KB，RTT=5ms，乙开辟的接收缓存为64KB，则甲从连接建立成功至发送窗口达到32KB，需经过的时间至少是？

  分析：cwnd=1KB，经过5个RTT变为32KB，发送窗口取cwnd和rwnd中的最小值=32KB，所以经过的时间至少是5ms×5=25ms

- **为了方便讨论，约定cwnd初始值为1个报文段，即cwnd=1。此后的讨论中也以报文段为单位。但cwnd本身的单位其实是字节。**

- 慢开始过程：

- 发送方A设置cwnd=1，并发送第一个报文段

- A收到B对第一个报文段的确认，将cwnd增大到2；并发送第二、第三个报文段

- A收到B对这两个报文段的确认，将cwnd增大到4，并发送第四到第七个报文段。

- 依次类推，每经过一个RTT时间，cwnd就会翻倍，直到cwnd增大**到**慢开始门限

  **！注意：假设当前cwnd是4而门限为6，再经过一个RTT时间后cwnd不应该翻倍为8，而是变成6！cwnd值一定不会超过门限值！**

- 慢开始门限ssthresh：一个阈值，当cwnd增大到该阈值时，转入拥塞避免算法

#### 拥塞避免

- 使cwnd在达到阈值之后继续缓慢增长（线性的）
- 每经过一个RTT时间，cwnd+1
- 拥塞避免并不能完全避免拥塞，它只是使网络比较不容易出现拥塞。

#### 拥塞处理

在慢开始阶段和拥塞避免阶段，若发送方判断网络出现拥塞（未按时收到确认），执行以下处理：

1. 慢开始门限设置为当前cwnd值的一半（但不能小于2）
2. 将cwnd重新设置为1，执行慢开始算法。

如此可在发生拥塞时迅速减小发送方发送到网络的分组数，让发生拥塞的路由器有足够的时间处理积压的分组。

![image-20221124183630098](https://streamazure.github.io/Computer_Basics_Notes/Computer_Network_Notes/0x05%20%E4%BC%A0%E8%BE%93%E5%B1%82/image-20221124183630098.png)

#### 快重传

快重传要求接收方立即发送确认，如果发生失序也立即确认最后一个有序报文段，让发送方尽早知道（在超时之前）有报文段丢失。否则一旦超时，发送方会误以为网络拥塞而采用拥塞避免算法，降低网络传输效率。

当发送方收到连续三次重复ACK时，立即重传丢失的报文段。

#### 快恢复

当发送方收到连续三个重复ACK时，除立即重传外，还执行以下处理：

1. 慢开始门限设置为当前cwnd值的一半
2. 将cwnd设置为慢开始门限的值（不是1！），执行拥塞避免算法，使拥塞窗口线性增大

因为cwnd并非从1开始，所以称为快恢复。

![image-20221124183655401](https://streamazure.github.io/Computer_Basics_Notes/Computer_Network_Notes/0x05%20%E4%BC%A0%E8%BE%93%E5%B1%82/image-20221124183655401.png)

# chap6 应用层

## 一、网络应用模型

### 1.1 客户机/服务器模型

特点：

- 网络中各计算机地位不平等，整个网络的管理工作由少数服务器担当，网络的管理非常集中和方便
- 客户机相互之间不直接通信
- 可扩展性不佳。受服务器硬件和网络带宽的限制，服务器支持的客户机数量有限

### 1.2 P2P模型

特点：

- 整个网络中的传输内容不再被保存在中心服务器上，每个结点同时具有下载、上传功能，权利和义务大体对等
- 减轻了服务器的计算压力，消除了对某个服务器的完全依赖，可以将任务分配到各个结点上大大提高了系统效率和资源利用率
- 多个客户机之间可以直接共享文档
- 可扩展性好，传统服务器有响应和带宽的限制
- 网络健壮性强，单个结点失效不会影响其他结点

缺点：

- 获得服务的同时还要提供服务，占用较多内存，影响整机速度

## 二、 域名系统DNS

### 2.1 DNS概述

#### 功能

- 把便于人们记忆的具有特定含义的主机名转换为便于机器处理的IP地址
- 联机分布式的数据库系统

#### 协议与端口

- 采用客户/服务器模型
- 基于UDP协议
- 端口53

### 2.2 层次域名空间

#### 域名与域划分

- 采用层次树状结构的命名方法，使得任何一个连接到因特网的主机或路由器，都有一个唯一的层次结构名称
- 域名规则
- 以"."隔开的各个部分称为“标号”
- 英文不区分大小写
- 除了连字符(-)外不允许使用其他标点符号
- 每个标号不超过63个字符，多标号组成的完整域名最长不超过255个字符
- 级别最低的域名在最左边（如www.baidu.com中，www是三级域名），级别最高的域名在最右边（com是顶级域名）
- 管理
- 每个域分别由不同的组织进行管理
- 每个组织可以把域再分成一定数量的子域，再将子域委托给其他组织管理

#### 顶级域名

1. 国家（地区）顶级域名。如“.cn”表示中国，“.us”表示美国，".uk"表示英国
2. 通用顶级域名。如“.com”（公司）、".net"（网络服务机构）、".org"（非盈利性组织）、".gov"（国家或政府部门）等
3. 基础结构域名。只有一个，即“arpa”，用于反向域名解析

### 2.3 域名服务器

- 区：一个服务器所负责管辖的范围，而不是以域为单位。一个区内的所有结点必须是能够连通的
- 每个区有相应的**权限域名服务器**，用于保存该区中的所有主机域名到IP地址的映射。
- 每个域名服务器不仅能进行域名到IP地址的解析，还必须具有连向其他域名服务器的信息
- 没有一台域名服务器具有因特网上所有主机的映射

#### 根域名服务器

所有的根域名服务器都知道所有的顶级域名服务器的IP地址

共有13个根服务器。

根域名服务器不直接完成域名解析，而是只告诉本地域名服务器下一步应当找哪个顶级域名服务器查询。

#### 顶级域名服务器

负责管理在改顶级域名服务器注册的所有二级域名。

收到DNS查询请求时，给出相应回答

- 直接完成域名解析，给出IP地址
- 不给出IP地址，而是给出下一步应当查找的域名服务器的IP地址

#### 授权域名服务器（权限域名服务器）

每台主机都必须在授权域名服务器处登记。

为了可靠性，一台主机最好至少有两个授权域名服务器。

许多域名服务器都同时充当本地域名服务器和授权域名服务器。

收到DNS查询请求时，总能直接完成域名解析，给出IP地址。

#### 本地域名服务器

每个ISP，一所大学，甚至一所大学中的各个系，都可以拥有一个本地域名服务器

当一台主机发出DNS查询请求时，查询请求报文发送给该主机的本地域名服务器

### 2.4 域名解析过程

#### 正向解析与反向解析

- 正向解析：将域名映射成IP地址
- 反向解析：将IP地址映射成域名

#### 纯递归查询

- 会给根服务器造成过大负载，很少用
- 流程

请求链：主机→本地域名服务器→根服务器→顶级域名服务器→权限域名服务器

响应链：权限域名服务器→顶级域名服务器→根服务器→本地域名服务器→主机

#### 递归与迭代相结合的查询

- 主机向本地域名服务器的查询采用递归查询

即，主机向本地域名服务器查询一个域名的IP地址，若本地域名服务器知道，则直接回答IP；否则自己迭代查询得到IP，再向主机回答IP。

- 本地域名服务器向根域名服务器的查询采用迭代查询

若本地域名服务器不知道对应IP地址，则向根域名服务器发起请求；

根域名服务器回复一个顶级域名服务器IP，本地域名服务器向顶级域名服务器发起请求；

顶级域名服务器回复一个权限域名服务器IP，本地域名服务器向权限域名服务器发起请求；

权限域名服务器回复一个最终IP，本地域名服务器再回复给主机

#### 报文数量

对于一个三级域名的查询，最多产生8个UDP报文。

1. 主机发给本地域名服务器的请求报文
2. 本地域名服务器发给根域名服务器的请求报文
3. 根域名服务器发给本地域名服务器的响应报文
4. 本地域名服务器发给顶级域名服务器的请求报文
5. 顶级域名服务器发给本地域名服务器的响应报文
6. 本地域名服务器发给权限域名服务器的请求报文
7. 权限域名服务器发给本地域名服务器的响应报文
8. 本地域名服务器发给主机的响应报文

#### 高速缓存

当一个DNS服务器接收到DNS查询结果时，将该DNS信息缓存在高速缓存中，以便下一次询问时直接提供IP地址。

高速缓存中的信息有生存期，到期自动丢弃。

## 三、文件传输协议FTP

### 3.1 FTP的工作原理

#### 概述

- FTP是因特网上使用得最广泛的文件传输协议
- 提供交互式访问，允许客户指明文件类型与格式，允许文件具有存取权限
- 屏蔽了各计算机系统的细节，适合于在**异构网络中的任意计算机**之间传送文件

#### 功能

- 提供不同种类主机系统之间的文件传输能力
- 以**用户权限管理**的方式提供用户对远程FTP服务器上的文件管理能力
- 以**匿名FTP**的方式提供公用文件共享的能力

#### 服务与端口

- 采用客户/服务器的工作方式
- 使用TCP
- 控制连接端口号21，数据连接端口号20
- 一个FTP服务器进程可同时为多个客户进程提供服务

### 3.2 控制连接与数据连接

FTP在工作时使用2个并行的TCP连接：控制连接和数据连接

#### 控制连接

- 监听21端口，等待客户连接
- 用于传输控制信息，都以7位ASCⅡ传送
- 控制连接在整个会话期间一直保持打开状态

#### 数据连接

- 数据连接用于连接客户端和服务器的数据传送进程
- 数据传送进程实际完成文件的传送
- 主动模式PORT（服务器连接到客户端的开放端口）
- 客户端连接到服务器的21端口，登录成功后，客户端随机开放一个端口，并通知服务器
- 服务器收到PORT命令和端口号后，通过20端口与该开放端口连接，发送数据
- 被动模式PASV（客户端连接到服务器的开放端口）
- 客户端要读取数据时，发送PASV命令到服务器，服务器随机开放一个端口，并通知客户端
- 客户端连接到服务器开放的端口进行数据传输

### 3.3 FTP与NFS

- 使用FTP修改服务器上的文件，需要将此文件传送到本地主机，再将修改后的文件副本传回服务器，较为耗时
- 使用NFS修改服务器上的文件，进程只需打开一个远程文件，并在文件的某个特定位置开始读写数据，用户只需要复制一个大文件中一个很小的片段，不需要复制整个大文件

## 四、电子邮件

### 4.1 电子邮件系统的构成

#### 用户代理（UA）

- 用户与电子邮件系统的接口
- 用户代理至少应当具有撰写、显示和邮件处理的功能
- 通常情况下，用户代理是一个运行在PC上的程序，如Outlook

#### 邮件服务器

- 发送和接收邮件，向发信人报告邮件传送的情况
- 邮件服务器采用客户/服务器方式工作，但必须能够同时充当客户和服务器
- 发送端邮件服务器的邮件发送协议（如SMTP），只要发现邮件缓存中有待发送的邮件，就向运行在接收端邮件服务器的邮件发送协议（如SMTP）发起TCP连接。所有邮件发送完毕后关闭TCP连接。

#### 邮件发送协议和读取协议

- 邮件发送协议：SMTP
- 邮件读取协议：POP3、IMAP

### 4.2 电子邮件格式与MIME

#### 电子邮件格式

- 信封
- 用户写好首部后，邮件系统自动提取信息并写到信封
- 内容
- 首部
  - To（必需关键字）：可以填入一个或多个收件人的电子邮件地址。电子邮件地址格式规定为：收件人邮箱名@邮箱所在主机的域名，如abc@cdf.com。abc这个名字在cdf.com这个服务器上必须唯一
  - From（必需关键字）：通常由邮件系统自动填入
  - Subje（可选关键字）：邮件主题
- 主体
  - 用户自由撰写的邮件内容

#### MIME

- SMTP只能传送7位ASCII码邮件，无法支持其他语言，也无法传送可执行文件及其他二进制对象
- MIME在SMTP的基础上增加了邮件主题的结构，定义了传送非ASCII码的编码规则
- 内容
- 5个新的邮件首部字段，包括MIME版本、内容描述、内容标识、传送编码、内容类型
- 定义了许多邮件内容的格式，对多媒体电子邮件的表示方法进行了标准化
- 定义了传送编码，可对任意内容格式进行转换，而不会被邮件系统改变

### 4.3 邮件传输协议

#### SMTP

- 负责发送邮件的SMTP进程是SMTP客户，负责接收邮件的SMTP进程是SMTP服务器
- TCP连接，端口号25
- SMTP不使用中间的邮件服务器，TCP连接在发送方和接收方两个邮件服务器之间直接建立
- 通信过程
- 连接建立：
  1. SMTP客户定期扫描邮件缓存，若发现有待发送邮件，则使用端口号25与SMTP服务器建立TCP连接。
  2. 连接建立后，SMTP服务器发出220 Service ready
  3. SMTP客户回应HELO命令，并附上发送方主机名
- 邮件传送：
  1. SMTP客户发出MAIL命令，后跟发件人地址。
  2. SMTP服务器回答250 OK。
  3. SMTP客户发送一个或多个RCPT（收件人）命令，后跟收件人地址。
  4. 每一个RCPT命令，服务器都要回答250 OK或550 No such user here。以此检查收件人地址是否正确。
  5. 若收件人地址OK，则SMTP客户发送DATA命令，表示开始传输内容
  6. SMTP回复 354 Start mail input; end with .（回车换行）。
  7. SMTP客户开始传输邮件内容，并用.表示邮件结束
- 连接释放
  1. 邮件发送完毕后，SMTP客户发送QUIT命令
  2. SMTP服务器回答221（服务关闭），表示服务器同意释放TCP连接

#### POP3

- 客户/服务器工作方式
- 接收方邮件服务器为POP3服务器，用户代理为POP3客户
- TCP连接，端口号110
- **在传输层明文传输密码**
- 基于ASCII码，但可以使用MIME发送非ACSII码数据
- 工作模式
- 下载并保留：用户读取邮件后，邮件依然保存在邮件服务器上
- 下载并删除：用户读取邮件后，删除邮件服务器上的邮件

#### IMAP

- 比POP3复杂，提供了创建文件夹、在不同文件夹之间移动邮件、在远程文件夹中查询邮件等联机命令
- 允许用户代理只获取报文的某些部分，如只读取首部。适合低带宽的情况。
- 需要维护会话用户的状态信息

#### 基于万维网的电子邮件

- 如Hotmial、Gmail等
- 用户浏览器与邮件服务器之间的邮件发送或接收使用的是HTTP
- 仅在不同邮件服务器之间传送邮件时才使用SMTP

## 五、万维网WWW

### 5.1 万维网的概念与组成结构

- 万维网是一个分布式、联机式的信息存储空间（不等于因特网！）
- 万维网的内核部分构成
- 统一资源定位符（URL）：负责标识万维网上的各种文档，并使每个文档在整个万维网的范围内有唯一的标识符
- 超文本传输协议（HTTP）：应用层协议，使用TCP
- 超文本标记语言（HTML）：一种文档结构的标记语言，描述页面上的各种信息
- URL的一般形式：

<协议>://<主机>:<端口>/<路径>

- 协议指获得万维网文档的方式，如http、ftp
- 主机是存放资源的主机在因特网中的域名或IP地址
- 端口和路径有时可省略
- 不区分大小写

### 5.2 超文本传输协议HTTP

#### HTTP过程

用户在浏览器地址栏输入网站并回车之后发生的事件顺序：

1. 浏览器分析链接指向页面的URL（http://www.tsinghua.edu.cn/chn/index.htm）
2. 浏览器向DNS请求解析域名www.tsinghua.edu.cn
3. DNS解析出域名对应的IP地址
4. 浏览器与该服务器建立TCP连接（默认端口80）
5. 浏览器发出HTTP请求：GET /chn/index.htm
6. 服务器通过HTTP响应将文件index.htm发送给浏览器
7. 释放TCP连接
8. 浏览器解释文件index.htm，并将页面显示给用户

#### HTTP特点

- 无连接：通信双方在交换HTTP报文时不需要建立HTTP连接
- 无状态：同一个客户第二次访问同一个服务器上的页面时，服务器的响应与第一次被访问时相同
- Cookie：网站服务器为访问用户生成的唯一识别码，添加在HTTP响应报文的"Set-cookie"字段并发回给用户；用户自身也管理了一个特定Cookie文件，收到该报文后，会在文件中添加该网站服务器的主机名和Cookie识别码。当用户继续浏览这个网站时，会在HTTP请求报文中自动添加Cookie发给服务器，服务器根据该Cookie识别用户，从自己数据库中找到相关活动记录，进而执行一些个性化工作
- 非持久连接与持久连接
- 非持久连接：对于每个网页元素对象的传输都要单独建立一个TCP连接。**每个对象引用都需要2个RTT**
- 持久连接（HTTP1.1默认方式）：网站服务器在发送响应后仍保持TCP连接，服务双方继续在该连接上传送后续的HTTP请求和响应报文
  - 非流水线方式：客户收到一个响应报文后才能发下一个请求。**每个对象引用都需要1个RTT**
  - 流水线方式：客户每遇到一个对象引用就立即发出一个请求，可以连续发送请求。**所有对象引用共计只需要1个RTT延迟**

#### HTTP请求报文常用方法

| 方法    | 意义                                            |
| :------ | :---------------------------------------------- |
| GET     | 请求读取由URL标识的信息                         |
| HEAD    | 请求读取由URL标识的信息的首部，不会返回请求对象 |
| POST    | 给服务器添加信息                                |
| CONNECT | 用于代理服务器                                  |